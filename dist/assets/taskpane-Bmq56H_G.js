(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function o(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=o(r);fetch(r.href,i)}})();const D="modulepreload",F=function(e,t){return new URL(e,t).href},P={},q=function(t,o,n){let r=Promise.resolve();if(o&&o.length>0){const c=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),u=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));r=Promise.allSettled(o.map(s=>{if(s=F(s,n),s in P)return;P[s]=!0;const d=s.endsWith(".css"),f=d?'[rel="stylesheet"]':"";if(!!n)for(let p=c.length-1;p>=0;p--){const E=c[p];if(E.href===s&&(!d||E.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${s}"]${f}`))return;const g=document.createElement("link");if(g.rel=d?"stylesheet":D,d||(g.as="script"),g.crossOrigin="",g.href=s,u&&g.setAttribute("nonce",u),document.head.appendChild(g),d)return new Promise((p,E)=>{g.addEventListener("load",p),g.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${s}`)))})}))}function i(c){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=c,window.dispatchEvent(a),!a.defaultPrevented)throw c}return r.then(c=>{for(const a of c||[])a.status==="rejected"&&i(a.reason);return t().catch(i)})},V="13.0.0",H="https://excelwizpro-backend.onrender.com",X=90*1e3,K=5e4;function G(e){return new Promise(t=>setTimeout(t,e))}function J(e){let t=e+1,o="";for(;t>0;){const n=(t-1)%26;o=String.fromCharCode(65+n)+o,t=Math.floor((t-1)/26)}return o}function $(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}const k=new Map;function A(e,t){return k.has(e)||k.set(e,new Set),k.get(e).add(t),()=>Z(e,t)}function Z(e,t){const o=k.get(e);o&&o.delete(t)}function x(e,t){const o=k.get(e);if(o)for(const n of o)try{n(t)}catch(r){console.warn(`EventBus handler for '${e}' failed:`,r)}}function Q(){var e,t,o,n,r,i,c;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((o=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:o.platform)||"unknown",version:((r=(n=Office.context)==null?void 0:n.diagnostics)==null?void 0:r.version)||"unknown",build:((c=(i=Office.context)==null?void 0:i.diagnostics)==null?void 0:c.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function Y(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const o=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(o),Office.onReady(e)),t>40&&(clearInterval(o),e({host:"unknown"}))},500)}})}async function ee(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),x("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function te(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async o=>{o.workbook.properties.load("title"),await o.sync()}),!0}catch{await G(350+t*120)}return x("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function N(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),x("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function ne(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(o=>{try{const n=o.onChanged;n&&n.add&&n.add(async()=>{x("workbook:changed")})}catch(n){console.warn("Sheet change listener unsupported:",n)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function oe(){return Q().version||"unknown"}let O="",_=0,I=!1;async function re(){return N(async e=>{var u;const t=e.workbook,o=t.worksheets;o.load("items/name,items/visibility"),await e.sync();const n=[],r=Object.create(null);for(const s of o.items){const d=s.visibility,f=d!=="Visible"?` (${d.toLowerCase()})`:"";n.push(`Sheet: ${s.name}${f}`);const m=s.getUsedRangeOrNullObject();if(m.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),m.isNullObject||m.rowCount<1)continue;const g=s.getRangeByIndexes(m.rowIndex,m.columnIndex,1,m.columnCount);g.load("values");const p=s.tables;p.load("items/name");const E=s.pivotTables;E.load("items/name"),await e.sync();const j=g.values,R=2,U=m.rowIndex+m.rowCount,z=R+K,B=Math.min(U,z);if(B>=R)for(let l=0;l<m.columnCount;l++){const S=String(j[0][l]??"").trim();if(!S)continue;let y=$(S);r[y]?(r[y]+=1,y=`${y}__${r[y]}`):r[y]=1;const C=J(m.columnIndex+l),w=s.name.replace(/'/g,"''");n.push(`${y} = '${w}'!${C}${R}:${C}${B}`)}const M=p.items.map(l=>({table:l,header:l.getHeaderRowRange(),body:l.getDataBodyRange()}));M.forEach(l=>{l.header.load("values"),l.body.load("address,rowCount,columnCount")}),await e.sync();for(const{table:l,header:S}of M)n.push(`Table: ${l.name}`),(((u=S.values)==null?void 0:u[0])||[]).forEach(C=>{if(!C)return;let w=$(`${l.name}.${C}`);r[w]?(r[w]+=1,w=`${w}__${r[w]}`):r[w]=1;const W=`${l.name}[${C}]`;n.push(`${w} = ${W}`)});E.items.forEach(l=>n.push(`PivotSource: ${l.name}`))}const i=t.names;i.load("items/name"),await e.sync();const c=[];for(const s of i.items){const d=s.getRange();d.load("address"),c.push({name:s.name,range:d})}await e.sync(),c.forEach(({name:s,range:d})=>{n.push(`NamedRange: ${s}`);let f=$(s);r[f]?(r[f]+=1,f=`${f}__${r[f]}`):r[f]=1,n.push(`${f} = ${d.address}`)});const a=n.join(`
`).slice(0,600);return console.log(`üîç Column map preview (v15.4 forced row2):
`,a),n.join(`
`)})}async function L(e=!1){if(!I)try{const t=Date.now();if(!e&&O&&t-_<X){console.log("üîÑ Using cached Smart Column Map (recent)");return}I=!0,console.log("üîÑ Refreshing Smart Column Map (v15.4)..."),O=await re(),_=Date.now(),console.log("‚úÖ Updated Smart Column Map (v15.4)"),x("columnMap:updated",{columnMap:O})}catch(t){console.warn("Auto-refresh failed:",t),x("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{I=!1}}function T(){return O}A("workbook:changed",()=>{O="",_=0,console.log("üßπ Column map cache invalidated due to workbook change")});let v=null;function ae(){return v||(v=document.createElement("div"),v.className="exwz-toast-container",Object.assign(v.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(v)),v}function h(e,t="info"){const o=ae(),n=document.createElement("div");n.textContent=e,n.className="exwz-toast";const r={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},i={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(n.style,r,i[t]||i.info),o.appendChild(n),setTimeout(()=>n.remove(),2400)}const se=Object.freeze(Object.defineProperty({__proto__:null,showToast:h},Symbol.toStringTag,{value:"Module"}));let b="";function ce(e=""){let t=String(e).replace(/\\+"/g,'"').replace(/\\+'/g,"'").replace(/\\/g,"").replace(/[\u200B\u200C\u200D\u200E\u200F\uFEFF\u00A0]/g,"").replace(/[\r\n\t]+/g," ").replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äò‚Äô]/g,"'").replace(/√ó/g,"*").replace(/√∑/g,"/").replace(/[‚Äì‚Äî‚àí]/g,"-").replace(/ {2,}/g," ").trim();return t.startsWith("=")||(t="="+t),t}function ie(){var e,t;try{const o=new URLSearchParams(window.location.search);if(o.get("apiBase"))return o.get("apiBase");const n=(t=(e=Office==null?void 0:Office.context)==null?void 0:e.roamingSettings)==null?void 0:t.get("excelwizpro_api_base");if(n)return n}catch{}return H}async function le(){const e=document.getElementById("sheetSelect"),t=document.getElementById("query"),o=document.getElementById("output"),n=document.getElementById("generateBtn"),r=document.getElementById("clearBtn"),i=document.getElementById("insertBtn");await N(async c=>{const a=c.workbook.worksheets;a.load("items/name"),await c.sync(),e.innerHTML="",a.items.forEach(u=>{const s=document.createElement("option");s.value=u.name,s.textContent=u.name,e.appendChild(s)})}),await L(!0),A("ui:toast",({message:c,kind:a})=>h(c,a)),n.addEventListener("click",async()=>{const c=t.value.trim();if(!c)return h("Enter a request.","warn");n.disabled=!0,o.textContent="Working‚Ä¶";try{await L(!1);let a=T();a||(await L(!0),a=T()),b=(await(await fetch(`${ie()}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:c,columnMap:a,excelVersion:oe(),mainSheet:e.value})})).json()).formula||'=ERROR("No formula")',console.log("RAW backend EXACT:",b,[...b]),o.textContent=b,h("Ready.","success")}catch(a){console.error(a),h("Generation failed.","error")}finally{n.disabled=!1}}),r.addEventListener("click",()=>{b="",o.textContent="",t.value=""}),i.addEventListener("click",async()=>{if(!b)return h("Nothing to insert.","warn");const c=ce(b);console.log("Cleaned before insert:",c);try{await Excel.run(async a=>{const u=a.workbook.getSelectedRange();if(u.load("rowCount,columnCount"),await a.sync(),u.rowCount!==1||u.columnCount!==1){const s=new Error("MULTI");throw s.code="MULTI",s}u.formulas=[[c]],await a.sync()}),h("Inserted.","success")}catch(a){console.error(a),a.code==="MULTI"?h("Select one cell.","warn"):h("Could not insert.","error")}})}console.log(`üß† ExcelWizPro Taskpane v${V} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function ue(){const e=await Y();return!await ee(e)||!await te()?!1:(await new Promise(t=>{document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await ue()){console.warn("Office not ready.");return}await ne(),await le();const{showToast:t}=await q(async()=>{const{showToast:o}=await Promise.resolve().then(()=>se);return{showToast:o}},void 0,import.meta.url);t("‚úÖ ExcelWizPro ready!","success")})();
