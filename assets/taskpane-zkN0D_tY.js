(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();let f="",w="",x=0,$=!1;const F=90*1e3,W=5e4;Office.onReady(async()=>{console.log("ExcelWizPro ready."),await H(),await P(!0),J(),G()});function v(e){return String(e||"").trim().toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g,"_").replace(/^_+|_+$/g,"")||"col"}function U(e){let t=e+1,r="";for(;t>0;){const o=(t-1)%26;r=String.fromCharCode(65+o)+r,t=Math.floor((t-1)/26)}return r}function V(){var e,t;try{return((t=(e=Office.context)==null?void 0:e.diagnostics)==null?void 0:t.version)||"unknown"}catch{return"unknown"}}async function z(){return Excel.run(async e=>{const t=e.workbook,r=t.worksheets;r.load("items/name,items/visibility"),await e.sync();const o=[],n=Object.create(null);function s(a){let d=a;return n[a]?(n[a]+=1,d=`${a}__${n[a]}`):n[a]=1,d}for(const a of r.items){const d=a.name,b=a.visibility||"Visible",j=b!=="Visible"?` (${b.toLowerCase()})`:"";o.push(`Sheet: ${d}${j}`);const l=a.getUsedRangeOrNullObject();if(l.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),!l.isNullObject&&l.rowCount>=2&&l.columnCount>=1){const y=Math.min(3,l.rowCount),O=a.getRangeByIndexes(l.rowIndex,l.columnIndex,y,l.columnCount);O.load("values");const S=a.tables,M=a.pivotTables;S.load("items/name"),M.load("items/name"),await e.sync();const q=O.values,A=l.rowIndex+y,B=l.rowIndex+l.rowCount-1,k=Math.min(A+1,B+1),N=Math.min(k+W-1,B+1);if(N>=k)for(let c=0;c<l.columnCount;c++){const m=[];for(let i=0;i<y;i++){const E=q[i][c];m[i]=E===null||E===""||E===void 0?"":String(E).trim()}let h="";for(let i=y-1;i>=0;i--)if(m[i]){h=m[i];break}if(!h)continue;let g=h;for(let i=0;i<y-1;i++)if(m[i]&&m[i]!==h){g=`${m[i]} - ${h}`;break}const p=v(g),I=s(p),C=U(l.columnIndex+c),D=`'${d.replace(/'/g,"''")}'!${C}${k}:${C}${N}`;o.push(`${I} = ${D}`)}const T=S.items.map(c=>({table:c,header:c.getHeaderRowRange(),body:c.getDataBodyRange()}));T.forEach(c=>{c.header.load("values"),c.body.load("rowCount,columnCount")}),await e.sync();for(const c of T){const m=c.table;o.push(`Table: ${m.name}`),(c.header.values&&c.header.values[0]||[]).forEach(g=>{if(!g)return;const p=String(g).trim();if(!p)return;const I=v(`${m.name}.${p}`),C=s(I),_=`${m.name}[${p}]`;o.push(`${C} = ${_}`)})}M.items.forEach(c=>{o.push(`PivotSource: ${c.name}`)})}}const u=t.names;u.load("items/name"),await e.sync();const R=[];for(const a of u.items){const d=a.getRange();d.load("address"),R.push({name:a.name,range:d})}await e.sync();for(const a of R){const d=v(a.name),b=s(d);o.push(`NamedRange: ${a.name}`),o.push(`${b} = ${a.range.address}`)}const L=o.join(`
`);return console.log(`Column map (first 800 chars):
`,L.slice(0,800)),L})}async function P(e=!1){const t=Date.now();if(!e&&w&&t-x<F)return w;if($)return await new Promise(r=>setTimeout(r,400)),w;try{$=!0;const r=await z();return w=r,x=Date.now(),r}catch(r){return console.error("Column map build failed:",r),""}finally{$=!1}}function G(){try{Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(r=>{try{const o=r.onChanged;o&&o.add&&o.add(async()=>{w="",x=0,console.log("Workbook changed – column map cache cleared.")})}catch(o){console.warn("Could not attach change listener:",o)}})})}catch(e){console.warn("Workbook listener init failed:",e)}}async function H(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync();const r=document.getElementById("sheetSelect");r.innerHTML="",t.items.forEach(o=>{const n=document.createElement("option");n.value=o.name,n.textContent=o.name,r.appendChild(n)})})}catch(e){console.error("Sheet load error:",e)}}function J(){document.getElementById("generateBtn").addEventListener("click",K),document.getElementById("clearBtn").addEventListener("click",X),document.getElementById("insertBtn").addEventListener("click",Q)}async function K(){const e=document.getElementById("query").value.trim(),t=document.getElementById("output"),r=document.getElementById("sheetSelect").value;if(!e){t.textContent="⚠️ Please enter a request.";return}t.textContent="⏳ Building column map...";const o=await P(!1);if(!o){t.textContent="❌ Could not build a column map from this workbook. Check that your data has headers and visible sheets.",f="";return}t.textContent="⏳ Generating formula...";try{const s=await(await fetch("https://excelwizpro-backend.onrender.com/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,mainSheet:r,columnMap:o,excelVersion:V()})})).json();if(s.error){t.textContent="❌ "+s.error,f="";return}const u=s.formula;if(!u){t.textContent="❌ No formula returned.",f="";return}if(/^=ERROR\("Missing input"\)/i.test(u)){t.textContent="⚠️ The AI couldn't find enough context in your workbook. Try checking your headers, selecting the correct sheet, and rephrasing your request.",f="";return}f=u,t.textContent=u}catch(n){t.textContent="❌ Backend is unreachable.",console.error(n)}}function X(){document.getElementById("query").value="",document.getElementById("output").textContent="",f=""}async function Q(){if(!f){alert("⚠️ Generate a formula first.");return}try{await Excel.run(async e=>{const t=e.workbook.getSelectedRange();t.formulas=[[f]],await e.sync()}),alert("Formula inserted!")}catch(e){console.error("Insert error:",e),alert("⚠️ Select a single cell first.")}}
