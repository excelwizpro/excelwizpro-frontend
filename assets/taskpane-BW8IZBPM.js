(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const V="modulepreload",G=function(e){return"/excelwizpro-frontend/"+e},N={},K=function(t,n,o){let r=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),a=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));r=Promise.allSettled(n.map(c=>{if(c=G(c),c in N)return;N[c]=!0;const l=c.endsWith(".css"),u=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${u}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":V,l||(d.as="script"),d.crossOrigin="",d.href=c,a&&d.setAttribute("nonce",a),document.head.appendChild(d),l)return new Promise((h,L)=>{d.addEventListener("load",h),d.addEventListener("error",()=>L(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(s){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=s,window.dispatchEvent(a),!a.defaultPrevented)throw s}return r.then(s=>{for(const a of s||[])a.status==="rejected"&&i(a.reason);return t().catch(i)})},X="13.0.0",J="https://excelwizpro-backend.onrender.com",Z=90*1e3,Q=5e4;function Y(e){return new Promise(t=>setTimeout(t,e))}function ee(e){let t=e+1,n="";for(;t>0;){const o=(t-1)%26;n=String.fromCharCode(65+o)+n,t=Math.floor((t-1)/26)}return n}function T(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}const b=new Map;function U(e,t){return b.has(e)||b.set(e,new Set),b.get(e).add(t),()=>te(e,t)}function te(e,t){const n=b.get(e);n&&n.delete(t)}function p(e,t){const n=b.get(e);if(n)for(const o of n)try{o(t)}catch(r){console.warn(`EventBus handler for '${e}' failed:`,r)}}function ne(){var e,t,n,o,r,i,s;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((n=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:n.platform)||"unknown",version:((r=(o=Office.context)==null?void 0:o.diagnostics)==null?void 0:r.version)||"unknown",build:((s=(i=Office.context)==null?void 0:i.diagnostics)==null?void 0:s.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function oe(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const n=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(n),Office.onReady(e)),t>40&&(clearInterval(n),e({host:"unknown"}))},500)}})}async function re(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),p("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function ae(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async n=>{n.workbook.properties.load("title"),await n.sync()}),!0}catch{await Y(350+t*120)}return p("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function j(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),p("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function se(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(n=>{try{const o=n.onChanged;o&&o.add&&o.add(async()=>{p("workbook:changed")})}catch(o){console.warn("Sheet change listener unsupported:",o)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function ie(){return ne().version||"unknown"}let C="",R=0,$=!1;function ce(e){const t=e.toLowerCase(),n={semanticType:"unknown",isId:!1,isDate:!1,isMeasure:!1,isCategory:!1,isBool:!1,isText:!1};return/(id|code|ref|key|number)$/.test(t)?(n.semanticType="id",n.isId=!0,n):/(date|day|month|year|week|period|time)/.test(t)?(n.semanticType="date",n.isDate=!0,n):(/(qty|quantity|units|amount|value|price|cost|total|sales|revenue|margin|profit)/.test(t)&&(n.semanticType="measure",n.isMeasure=!0),/(warehouse|region|zone|type|class|status|route|location|customer|client)/.test(t)&&(n.semanticType="category",n.isCategory=!0),/(flag|yes|no|true|false|active|enabled|complete|closed|confirmed)/.test(t)&&(n.semanticType="boolean",n.isBool=!0),/(name|description|comment|note|text)/.test(t)&&(n.semanticType=n.semanticType==="unknown"?"text":n.semanticType,n.isText=!0),n)}function le(e){const t=e.length-1;let n=e[t]||"";if(!n)return"";for(let o=0;o<t;o++)if(e[o]&&e[o]!==n)return`${e[o]} - ${n}`;return n}function ue(e,t,n,o){return`'${e.replace(/'/g,"''")}'!${t}${n}:${t}${o}`}async function de(){return j(async e=>{const t=e.workbook,n=t.worksheets;n.load("items/name,items/visibility"),await e.sync();const o=[],r=Object.create(null);for(const a of n.items){const c=a.visibility,l=c!=="Visible"?` (${c.toLowerCase()})`:"";o.push(`Sheet: ${a.name}${l}`);const u=a.getUsedRangeOrNullObject();if(u.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),u.isNullObject||u.rowCount<2)continue;const d=Math.min(3,u.rowCount),h=a.getRangeByIndexes(u.rowIndex,u.columnIndex,d,u.columnCount);h.load("values"),await e.sync();const L=h.values,q=u.rowIndex+d,D=u.rowIndex+u.rowCount-1,S=q+1,W=S+Q-1,F=D+1,B=Math.min(F,W);if(B<S)continue;for(let f=0;f<u.columnCount;f++){const E=[];for(let I=0;I<d;I++){const k=L[I][f];E.push(k!==null&&k!==""&&k!==void 0?String(k).trim():"")}const x=le(E);if(!x)continue;const{semanticType:v}=ce(x);let m=T(x);r[m]?(r[m]+=1,m=`${m}__${r[m]}`):r[m]=1;const y=ee(u.columnIndex+f),H=ue(a.name,y,S,B);o.push(`${m} = ${H}  #${v}`)}const M=a.tables;M.load("items/name"),await e.sync();for(const f of M.items){o.push(`Table: ${f.name}`);const E=f.getHeaderRowRange();E.load("values"),await e.sync(),(E.values[0]||[]).forEach(v=>{if(!v)return;const m=String(v).trim();let y=T(`${f.name}.${m}`);r[y]?(r[y]+=1,y=`${y}__${r[y]}`):r[y]=1,o.push(`${y} = ${f.name}[${m}]`)})}const P=a.pivotTables;P.load("items/name"),await e.sync(),P.items.forEach(f=>o.push(`PivotSource: ${f.name}`))}const i=t.names;i.load("items/name"),await e.sync();for(const a of i.items){const c=a.getRange();c.load("address"),await e.sync(),o.push(`NamedRange: ${a.name}`);let l=T(a.name);r[l]?(r[l]+=1,l=`${l}__${r[l]}`):r[l]=1,o.push(`${l} = ${c.address}`)}const s=o.join(`
`).slice(0,600);return console.log(`üîç Column map v15 preview:
`,s),o.join(`
`)})}async function _(e=!1){if(!$)try{const t=Date.now();if(!e&&C&&t-R<Z){console.log("üîÑ Using cached Smart Column Map (v15)");return}$=!0,console.log("‚öôÔ∏è Refreshing Smart Column Map v15‚Ä¶"),C=await de(),R=Date.now(),console.log("‚úÖ Column Map v15 updated"),p("columnMap:updated",{columnMap:C})}catch(t){console.warn("Auto-refresh failed:",t),p("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{$=!1}}function A(){return C}U("workbook:changed",()=>{C="",R=0,console.log("üßπ Column map v15 invalidated due to workbook change")});let g=null;function fe(){return g||(g=document.createElement("div"),g.className="exwz-toast-container",Object.assign(g.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(g)),g}function w(e,t="info"){const n=fe(),o=document.createElement("div");o.textContent=e,o.className="exwz-toast";const r={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},i={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(o.style,r,i[t]||i.info),n.appendChild(o),setTimeout(()=>o.remove(),2400)}const me=Object.freeze(Object.defineProperty({__proto__:null,showToast:w},Symbol.toStringTag,{value:"Module"}));function z(){var e;try{const t=new URLSearchParams(window.location.search);if(t.get("apiBase"))return t.get("apiBase");if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const n=Office.context.roamingSettings.get("excelwizpro_api_base");if(n)return n}}catch(t){console.warn("API base resolution error:",t)}return J}let O="";async function we(){const e=document.getElementById("sheetSelect"),t=document.getElementById("query"),n=document.getElementById("output"),o=document.getElementById("generateBtn"),r=document.getElementById("clearBtn"),i=document.getElementById("insertBtn");if(!e||!t||!n){console.error("‚ùå UI elements missing");return}await j(async s=>{const a=s.workbook.worksheets;a.load("items/name"),await s.sync(),e.innerHTML="",a.items.forEach(c=>{const l=document.createElement("option");l.value=c.name,l.textContent=c.name,e.appendChild(l)})}),await _(!0),U("ui:toast",({message:s,kind:a})=>w(s,a)),ye(z()),o.addEventListener("click",async()=>{const s=t.value.trim();if(!s){w("‚ö†Ô∏è Enter a request","warn");return}if(!navigator.onLine){w("üì¥ Offline","warn");return}o.disabled=!0,n.textContent="‚è≥ Generating‚Ä¶";try{await _(!1);let a=A();a||(await _(!0),a=A());const c=ie(),l={query:s,columnMap:a,excelVersion:c,mainSheet:e.value},u=z();O=(await(await fetch(`${u}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})).json()).formula||'=ERROR("No formula returned")',n.textContent=O,w("‚úÖ Formula ready","success")}catch(a){console.error("Generation error:",a),n.textContent="‚ùå Error ‚Äî see details in console",w("‚ö†Ô∏è Formula generation failed","error")}finally{o.disabled=!1}}),r.addEventListener("click",()=>{n.textContent="",t.value=""}),i.addEventListener("click",async()=>{if(!O){w("‚ö†Ô∏è Nothing to insert","warn");return}try{await Excel.run(async s=>{const a=s.workbook.getSelectedRange();if(a.load("rowCount,columnCount"),await s.sync(),a.rowCount!==1||a.columnCount!==1){const c=new Error("MULTI_CELL_SELECTION");throw c.code="MULTI_CELL_SELECTION",c}a.formulas=[[O]],await s.sync()}),w("‚úÖ Inserted","success")}catch(s){(s==null?void 0:s.code)==="MULTI_CELL_SELECTION"?w("‚ö†Ô∏è Select a single cell","warn"):w("‚ö†Ô∏è Could not insert formula","error")}})}async function ye(e){try{(await fetch(`${e}/health`,{method:"GET"})).ok?p("backend:ready"):p("backend:error")}catch{p("backend:error")}}console.log(`üß† ExcelWizPro Taskpane v${X} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function pe(){const e=await oe();return!await re(e)||!await ae()?!1:(await new Promise(t=>{document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await pe()){console.warn("Office not ready.");return}await se(),await we();const{showToast:t}=await K(async()=>{const{showToast:n}=await Promise.resolve().then(()=>me);return{showToast:n}},void 0);t("‚úÖ ExcelWizPro ready!","success")})();
