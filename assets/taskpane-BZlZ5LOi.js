(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();const G="modulepreload",K=function(e){return"/excelwizpro-frontend/"+e},A={},X=function(t,n,r){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),s=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));o=Promise.allSettled(n.map(i=>{if(i=K(i),i in A)return;A[i]=!0;const u=i.endsWith(".css"),y=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${y}`))return;const l=document.createElement("link");if(l.rel=u?"stylesheet":G,u||(l.as="script"),l.crossOrigin="",l.href=i,s&&l.setAttribute("nonce",s),document.head.appendChild(l),u)return new Promise((E,x)=>{l.addEventListener("load",E),l.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${i}`)))})}))}function c(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return o.then(a=>{for(const s of a||[])s.status==="rejected"&&c(s.reason);return t().catch(c)})},J="13.0.0",Z="https://excelwizpro-backend.onrender.com",Q=90*1e3,Y=5e4;function ee(e){return new Promise(t=>setTimeout(t,e))}function te(e){let t=e+1,n="";for(;t>0;){const r=(t-1)%26;n=String.fromCharCode(65+r)+n,t=Math.floor((t-1)/26)}return n}function R(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}const b=new Map;function z(e,t){return b.has(e)||b.set(e,new Set),b.get(e).add(t),()=>ne(e,t)}function ne(e,t){const n=b.get(e);n&&n.delete(t)}function h(e,t){const n=b.get(e);if(n)for(const r of n)try{r(t)}catch(o){console.warn(`EventBus handler for '${e}' failed:`,o)}}function oe(){var e,t,n,r,o,c,a;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((n=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:n.platform)||"unknown",version:((o=(r=Office.context)==null?void 0:r.diagnostics)==null?void 0:o.version)||"unknown",build:((a=(c=Office.context)==null?void 0:c.diagnostics)==null?void 0:a.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function re(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const n=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(n),Office.onReady(e)),t>40&&(clearInterval(n),e({host:"unknown"}))},500)}})}async function ae(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),h("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function se(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async n=>{n.workbook.properties.load("title"),await n.sync()}),!0}catch{await ee(350+t*120)}return h("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function q(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),h("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function ce(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(n=>{try{const r=n.onChanged;r&&r.add&&r.add(async()=>{h("workbook:changed")})}catch(r){console.warn("Sheet change listener unsupported:",r)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function ie(){return oe().version||"unknown"}let C="",T=0,_=!1;function le(e){for(let t=0;t<e.length;t++){const n=e[t];if(n.filter(o=>o&&o!=="").length>=1)return{headerRowIndex:t,headerValues:n}}return{headerRowIndex:0,headerValues:e[0]}}async function ue(){return q(async e=>{var a;const t=e.workbook,n=t.worksheets;n.load("items/name,items/visibility"),await e.sync();const r=[],o=Object.create(null);for(const s of n.items){const i=s.name.replace(/'/g,"''"),u=s.visibility,y=u!=="Visible"?` (${u.toLowerCase()})`:"";r.push(`Sheet: ${i}${y}`);const l=s.getUsedRangeOrNullObject();if(l.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),l.isNullObject||l.rowCount<1)continue;const E=Math.min(3,l.rowCount),x=s.getRangeByIndexes(l.rowIndex,l.columnIndex,E,l.columnCount);x.load("values"),await e.sync();const P=x.values,{headerRowIndex:D,headerValues:V}=le(P),W=l.rowIndex+D+1,F=l.rowIndex+l.rowCount-1,O=W+1,H=O+Y-1,B=Math.min(F+1,H);if(B<O)continue;for(let d=0;d<l.columnCount;d++){const g=V[d];if(!g||String(g).trim()==="")for(let L=E-1;L>=0;L--){const S=P[L][d];if(S&&S!==""){g=S;break}}if(!g)continue;const v=String(g).trim();if(!v)continue;let f=R(v);o[f]?(o[f]++,f=`${f}__${o[f]}`):o[f]=1;const m=te(l.columnIndex+d),I=`'${i}'!${m}${O}:${m}${B}`;r.push(`${f} = ${I}`)}const M=s.tables;M.load("items/name"),await e.sync();for(const d of M.items){r.push(`Table: ${d.name}`);const g=d.getHeaderRowRange();g.load("values"),await e.sync(),(((a=g.values)==null?void 0:a[0])||[]).forEach(f=>{if(!f)return;let m=R(`${d.name}.${f}`);o[m]?(o[m]++,m=`${m}__${o[m]}`):o[m]=1;const I=`${d.name}[${f}]`;r.push(`${m} = ${I}`)})}const N=s.pivotTables;N.load("items/name"),await e.sync(),N.items.forEach(d=>r.push(`PivotSource: ${d.name}`))}const c=t.names;c.load("items/name"),await e.sync();for(const s of c.items){const i=s.getRange();i.load("address"),await e.sync(),r.push(`NamedRange: ${s.name}`);let u=R(s.name);o[u]?(o[u]++,u=`${u}__${o[u]}`):o[u]=1,r.push(`${u} = ${i.address}`)}return console.log(`üü¶ ColumnMapper v7 preview
`,r.slice(0,40).join(`
`)),r.join(`
`)})}async function $(e=!1){if(!_)try{const t=Date.now();if(!e&&C&&t-T<Q){console.log("‚ôªÔ∏è Using cached column map (fresh)");return}_=!0,console.log("üîÑ Rebuilding Smart Column Map v7‚Ä¶"),C=await ue(),T=Date.now(),h("columnMap:updated",{columnMap:C}),console.log("‚úÖ Smart Column Map v7 built")}catch(t){console.warn("‚ùå Column map build error:",t),h("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{_=!1}}function U(){return C}z("workbook:changed",()=>{C="",T=0,console.log("üßπ Column map cache cleared (workbook changed)")});let p=null;function de(){return p||(p=document.createElement("div"),p.className="exwz-toast-container",Object.assign(p.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(p)),p}function w(e,t="info"){const n=de(),r=document.createElement("div");r.textContent=e,r.className="exwz-toast";const o={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},c={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(r.style,o,c[t]||c.info),n.appendChild(r),setTimeout(()=>r.remove(),2400)}const fe=Object.freeze(Object.defineProperty({__proto__:null,showToast:w},Symbol.toStringTag,{value:"Module"}));function j(){var e;try{const t=new URLSearchParams(window.location.search);if(t.get("apiBase"))return t.get("apiBase");if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const n=Office.context.roamingSettings.get("excelwizpro_api_base");if(n)return n}}catch(t){console.warn("API base resolution error:",t)}return Z}let k="";async function me(){const e=document.getElementById("sheetSelect"),t=document.getElementById("query"),n=document.getElementById("output"),r=document.getElementById("generateBtn"),o=document.getElementById("clearBtn"),c=document.getElementById("insertBtn");if(!e||!t||!n){console.error("‚ùå UI elements missing");return}await q(async a=>{const s=a.workbook.worksheets;s.load("items/name"),await a.sync(),e.innerHTML="",s.items.forEach(i=>{const u=document.createElement("option");u.value=i.name,u.textContent=i.name,e.appendChild(u)})}),await $(!0),z("ui:toast",({message:a,kind:s})=>w(a,s)),we(j()),r.addEventListener("click",async()=>{const a=t.value.trim();if(!a){w("‚ö†Ô∏è Enter a request","warn");return}if(!navigator.onLine){w("üì¥ Offline","warn");return}r.disabled=!0,n.textContent="‚è≥ Generating‚Ä¶";try{await $(!1);let s=U();s||(await $(!0),s=U());const i=ie(),u={query:a,columnMap:s,excelVersion:i,mainSheet:e.value},y=j();k=(await(await fetch(`${y}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)})).json()).formula||'=ERROR("No formula returned")',n.textContent=k,w("‚úÖ Formula ready","success")}catch(s){console.error("Generation error:",s),n.textContent="‚ùå Error ‚Äî see details in console",w("‚ö†Ô∏è Formula generation failed","error")}finally{r.disabled=!1}}),o.addEventListener("click",()=>{n.textContent="",t.value=""}),c.addEventListener("click",async()=>{if(!k){w("‚ö†Ô∏è Nothing to insert","warn");return}try{await Excel.run(async a=>{const s=a.workbook.getSelectedRange();if(s.load("rowCount,columnCount"),await a.sync(),s.rowCount!==1||s.columnCount!==1){const i=new Error("MULTI_CELL_SELECTION");throw i.code="MULTI_CELL_SELECTION",i}s.formulas=[[k]],await a.sync()}),w("‚úÖ Inserted","success")}catch(a){(a==null?void 0:a.code)==="MULTI_CELL_SELECTION"?w("‚ö†Ô∏è Select a single cell","warn"):w("‚ö†Ô∏è Could not insert formula","error")}})}async function we(e){try{(await fetch(`${e}/health`,{method:"GET"})).ok?h("backend:ready"):h("backend:error")}catch{h("backend:error")}}console.log(`üß† ExcelWizPro Taskpane v${J} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function he(){const e=await re();return!await ae(e)||!await se()?!1:(await new Promise(t=>{document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await he()){console.warn("Office not ready.");return}await ce(),await me();const{showToast:t}=await X(async()=>{const{showToast:n}=await Promise.resolve().then(()=>fe);return{showToast:n}},void 0);t("‚úÖ ExcelWizPro ready!","success")})();
