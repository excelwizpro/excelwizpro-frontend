(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const K="modulepreload",X=function(e){return"/excelwizpro-frontend/"+e},A={},J=function(t,n,a){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),c=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));o=Promise.allSettled(n.map(s=>{if(s=X(s),s in A)return;A[s]=!0;const u=s.endsWith(".css"),w=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${s}"]${w}`))return;const l=document.createElement("link");if(l.rel=u?"stylesheet":K,u||(l.as="script"),l.crossOrigin="",l.href=s,c&&l.setAttribute("nonce",c),document.head.appendChild(l),u)return new Promise((y,O)=>{l.addEventListener("load",y),l.addEventListener("error",()=>O(new Error(`Unable to preload CSS for ${s}`)))})}))}function i(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return o.then(r=>{for(const c of r||[])c.status==="rejected"&&i(c.reason);return t().catch(i)})},Z="13.0.0",Q="https://excelwizpro-backend.onrender.com",Y=90*1e3,ee=5e4;function te(e){return new Promise(t=>setTimeout(t,e))}function ne(e){let t=e+1,n="";for(;t>0;){const a=(t-1)%26;n=String.fromCharCode(65+a)+n,t=Math.floor((t-1)/26)}return n}function R(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}const x=new Map;function z(e,t){return x.has(e)||x.set(e,new Set),x.get(e).add(t),()=>oe(e,t)}function oe(e,t){const n=x.get(e);n&&n.delete(t)}function p(e,t){const n=x.get(e);if(n)for(const a of n)try{a(t)}catch(o){console.warn(`EventBus handler for '${e}' failed:`,o)}}function re(){var e,t,n,a,o,i,r;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((n=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:n.platform)||"unknown",version:((o=(a=Office.context)==null?void 0:a.diagnostics)==null?void 0:o.version)||"unknown",build:((r=(i=Office.context)==null?void 0:i.diagnostics)==null?void 0:r.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function ae(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const n=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(n),Office.onReady(e)),t>40&&(clearInterval(n),e({host:"unknown"}))},500)}})}async function se(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),p("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function ce(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async n=>{n.workbook.properties.load("title"),await n.sync()}),!0}catch{await te(350+t*120)}return p("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function D(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),p("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function ie(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(n=>{try{const a=n.onChanged;a&&a.add&&a.add(async()=>{p("workbook:changed")})}catch(a){console.warn("Sheet change listener unsupported:",a)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function le(){return re().version||"unknown"}let k="",T=0,_=!1;async function ue(){return D(async e=>{const t=e.workbook,n=t.worksheets;n.load("items/name,items/visibility"),await e.sync();const a=[],o=Object.create(null);for(const s of n.items){const u=s.visibility,w=u!=="Visible"?` (${u.toLowerCase()})`:"";a.push(`Sheet: ${s.name}${w}`);const l=s.getUsedRangeOrNullObject();if(l.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),l.isNullObject||l.rowCount<2)continue;const y=Math.min(3,l.rowCount),O=s.getRangeByIndexes(l.rowIndex,l.columnIndex,y,l.columnCount);O.load("values");const B=s.tables;B.load("items/name");const P=s.pivotTables;P.load("items/name"),await e.sync();const q=O.values,W=l.rowIndex+y,F=l.rowIndex+l.rowCount-1,I=W+1,V=I+ee-1,H=F+1,M=Math.min(H,V);if(M>=I)for(let d=0;d<l.columnCount;d++){const g=[];for(let m=0;m<y;m++){const S=q[m][d];g[m]=S!==null&&S!==""&&S!==void 0?String(S).trim():""}let C="";for(let m=y-1;m>=0;m--)if(g[m]){C=g[m];break}if(!C)continue;let E=C;for(let m=0;m<y-1;m++)if(g[m]&&g[m]!==C){E=`${g[m]} - ${E}`;break}let f=R(E);o[f]?(o[f]+=1,f=`${f}__${o[f]}`):o[f]=1;const v=ne(l.columnIndex+d),G=s.name.replace(/'/g,"''");a.push(`${f} = '${G}'!${v}${I}:${v}${M}`)}const N=B.items.map(d=>({table:d,header:d.getHeaderRowRange(),body:d.getDataBodyRange()}));N.forEach(d=>{d.header.load("values"),d.body.load("address,rowCount,columnCount")}),await e.sync();for(const{table:d,header:g}of N)a.push(`Table: ${d.name}`),(g.values&&g.values[0]||[]).forEach(E=>{if(!E)return;let f=R(`${d.name}.${E}`);o[f]?(o[f]+=1,f=`${f}__${o[f]}`):o[f]=1;const v=`${d.name}[${E}]`;a.push(`${f} = ${v}`)});P.items.forEach(d=>a.push(`PivotSource: ${d.name}`))}const i=t.names;i.load("items/name"),await e.sync();const r=[];for(const s of i.items){const u=s.getRange();u.load("address"),r.push({name:s.name,range:u})}await e.sync(),r.forEach(({name:s,range:u})=>{a.push(`NamedRange: ${s}`);let w=R(s);o[w]?(o[w]+=1,w=`${w}__${o[w]}`):o[w]=1,a.push(`${w} = ${u.address}`)});const c=a.join(`
`).slice(0,600);return console.log(`üîç Column map preview (classic):
`,c),a.join(`
`)})}async function $(e=!1){if(!_)try{const t=Date.now();if(!e&&k&&t-T<Y){console.log("üîÑ Using cached Smart Column Map (recent)");return}_=!0,console.log("üîÑ Refreshing Smart Column Map‚Ä¶"),k=await ue(),T=Date.now(),console.log("‚úÖ Updated Smart Column Map (classic)"),p("columnMap:updated",{columnMap:k})}catch(t){console.warn("Auto-refresh failed:",t),p("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{_=!1}}function U(){return k}z("workbook:changed",()=>{k="",T=0,console.log("üßπ Column map cache invalidated due to workbook change")});let b=null;function de(){return b||(b=document.createElement("div"),b.className="exwz-toast-container",Object.assign(b.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(b)),b}function h(e,t="info"){const n=de(),a=document.createElement("div");a.textContent=e,a.className="exwz-toast";const o={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},i={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(a.style,o,i[t]||i.info),n.appendChild(a),setTimeout(()=>a.remove(),2400)}const fe=Object.freeze(Object.defineProperty({__proto__:null,showToast:h},Symbol.toStringTag,{value:"Module"}));function j(){var e;try{const t=new URLSearchParams(window.location.search);if(t.get("apiBase"))return t.get("apiBase");if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const n=Office.context.roamingSettings.get("excelwizpro_api_base");if(n)return n}}catch(t){console.warn("API base resolution error:",t)}return Q}let L="";async function me(){const e=document.getElementById("sheetSelect"),t=document.getElementById("query"),n=document.getElementById("output"),a=document.getElementById("generateBtn"),o=document.getElementById("clearBtn"),i=document.getElementById("insertBtn");if(!e||!t||!n){console.error("‚ùå UI elements missing");return}await D(async r=>{const c=r.workbook.worksheets;c.load("items/name"),await r.sync(),e.innerHTML="",c.items.forEach(s=>{const u=document.createElement("option");u.value=s.name,u.textContent=s.name,e.appendChild(u)})}),await $(!0),z("ui:toast",({message:r,kind:c})=>h(r,c)),we(j()),a.addEventListener("click",async()=>{const r=t.value.trim();if(!r){h("‚ö†Ô∏è Enter a request","warn");return}if(!navigator.onLine){h("üì¥ Offline","warn");return}a.disabled=!0,n.textContent="‚è≥ Generating‚Ä¶";try{await $(!1);let c=U();c||(await $(!0),c=U());const s=le(),u={query:r,columnMap:c,excelVersion:s,mainSheet:e.value},w=j();L=(await(await fetch(`${w}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)})).json()).formula||'=ERROR("No formula returned")',n.textContent=L,h("‚úÖ Formula ready","success")}catch(c){console.error("Generation error:",c),n.textContent="‚ùå Error ‚Äî see details in console",h("‚ö†Ô∏è Formula generation failed","error")}finally{a.disabled=!1}}),o.addEventListener("click",()=>{n.textContent="",t.value=""}),i.addEventListener("click",async()=>{if(!L){h("‚ö†Ô∏è Nothing to insert","warn");return}try{await Excel.run(async r=>{const c=r.workbook.getSelectedRange();if(c.load("rowCount,columnCount"),await r.sync(),c.rowCount!==1||c.columnCount!==1){const s=new Error("MULTI_CELL_SELECTION");throw s.code="MULTI_CELL_SELECTION",s}c.formulas=[[L]],await r.sync()}),h("‚úÖ Inserted","success")}catch(r){(r==null?void 0:r.code)==="MULTI_CELL_SELECTION"?h("‚ö†Ô∏è Select a single cell","warn"):h("‚ö†Ô∏è Could not insert formula","error")}})}async function we(e){try{(await fetch(`${e}/health`,{method:"GET"})).ok?p("backend:ready"):p("backend:error")}catch{p("backend:error")}}console.log(`üß† ExcelWizPro Taskpane v${Z} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function he(){const e=await ae();return!await se(e)||!await ce()?!1:(await new Promise(t=>{document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await he()){console.warn("Office not ready.");return}await ie(),await me();const{showToast:t}=await J(async()=>{const{showToast:n}=await Promise.resolve().then(()=>fe);return{showToast:n}},void 0);t("‚úÖ ExcelWizPro ready!","success")})();
