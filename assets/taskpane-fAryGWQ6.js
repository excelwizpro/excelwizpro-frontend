(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function o(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(s){if(s.ep)return;s.ep=!0;const i=o(s);fetch(s.href,i)}})();const Q="modulepreload",ee=function(t){return"/excelwizpro-frontend/"+t},z={},te=function(n,o,e){let s=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),c=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=Promise.allSettled(o.map(d=>{if(d=ee(d),d in z)return;z[d]=!0;const a=d.endsWith(".css"),l=a?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${l}`))return;const f=document.createElement("link");if(f.rel=a?"stylesheet":Q,a||(f.as="script"),f.crossOrigin="",f.href=d,c&&f.setAttribute("nonce",c),document.head.appendChild(f),a)return new Promise((m,y)=>{f.addEventListener("load",m),f.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return s.then(r=>{for(const c of r||[])c.status==="rejected"&&i(c.reason);return n().catch(i)})},ne="13.0.0",oe="https://excelwizpro-backend.onrender.com",re=90*1e3,ae=5e4;function se(t){return new Promise(n=>setTimeout(n,t))}function ie(t){let n=t+1,o="";for(;n>0;){const e=(n-1)%26;o=String.fromCharCode(65+e)+o,n=Math.floor((n-1)/26)}return o}function ce(t){return String(t||"").trim().toLowerCase().replace(/\s+/g,"_")}const S=new Map;function H(t,n){return S.has(t)||S.set(t,new Set),S.get(t).add(n),()=>de(t,n)}function de(t,n){const o=S.get(t);o&&o.delete(n)}function p(t,n){const o=S.get(t);if(o)for(const e of o)try{e(n)}catch(s){console.warn(`EventBus handler for '${t}' failed:`,s)}}function le(){var t,n,o,e,s,i,r;try{return{host:((t=Office.context)==null?void 0:t.host)||"unknown",platform:((o=(n=Office.context)==null?void 0:n.diagnostics)==null?void 0:o.platform)||"unknown",version:((s=(e=Office.context)==null?void 0:e.diagnostics)==null?void 0:s.version)||"unknown",build:((r=(i=Office.context)==null?void 0:i.diagnostics)==null?void 0:r.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function ue(){return new Promise(t=>{if(window.Office&&Office.onReady)Office.onReady(t);else{let n=0;const o=setInterval(()=>{n++,window.Office&&Office.onReady&&(clearInterval(o),Office.onReady(t)),n>40&&(clearInterval(o),t({host:"unknown"}))},500)}})}async function fe(t){return!t||t.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",t&&t.host),p("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function me(t=20){for(let n=1;n<=t;n++)try{return await Excel.run(async o=>{o.workbook.properties.load("title"),await o.sync()}),!0}catch{await se(350+n*120)}return p("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function G(t){try{return await Excel.run(t)}catch(n){throw console.warn("Excel.run failed:",n),p("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),n}}async function he(){try{await Excel.run(async t=>{const n=t.workbook.worksheets;n.load("items/name"),await t.sync(),n.items.forEach(o=>{try{const e=o.onChanged;e&&e.add&&e.add(async()=>{p("workbook:changed")})}catch(e){console.warn("Sheet change listener unsupported:",e)}})})}catch(t){console.warn("Workbook change listeners failed:",t)}}function we(){return le().version||"unknown"}let v="",T=0,R=!1;function B(t){return String(t||"").toLowerCase().replace(/[^a-z0-9]+/gi," ").replace(/\s+/g," ").trim()}const pe=[["warehouse","wh","whse","depot","stock"],["order","orders","ord"],["confirmed","confirm","conf","cnf"],["mhir1","mhir","mhi r1","mhi-r1","mhi_r1"],["date","dt"],["qty","quantity","amount","volume"],["status","state","flag"],["customer","client","cust"],["id","identifier","ref","reference"]];function ge(t){const n=B(t);if(!n)return[];const o=n.split(" ").filter(Boolean),e=new Set(o);for(const s of o)for(const i of pe)i.includes(s)&&i.forEach(r=>e.add(r));return[...e]}function ye(t){const n=String(t||"").trim();return n?!!(/^\d{4}[-/]\d{1,2}[-/]\d{1,2}$/.test(n)||/^\d{1,2}[-/]\d{1,2}[-/]\d{2,4}$/.test(n)||/(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i.test(n)):!1}function D(t,n){const o=[],e=B(t.join(" "));if(!e)return o;let s=0,i=0,r=0;for(const c of n){const d=String(c??"").trim();if(!d)continue;r++;const a=Number(d.replace(/,/g,""));if(!Number.isNaN(a)){s++;continue}ye(d)&&i++}return r>0&&(i/r>=.6&&o.push("date"),s/r>=.6&&o.push("numeric")),/\b(id|ref|reference|order number|ord no)\b/.test(e)&&o.push("id"),/\b(qty|quantity|amount|value|price|total|sum)\b/.test(e)&&o.push("measure"),/\b(status|state|flag|ok)\b/.test(e)&&o.push("status"),/\b(customer|client|account|cust)\b/.test(e)&&o.push("entity"),o}function W(t,n,o){const e=new Set,s=t.map(l=>String(l||"").trim()).filter(Boolean);if(!s.length)return[];const i=s[s.length-1],r=s.join(" - "),c=B(n);e.add(i),e.add(r),s.forEach(l=>e.add(l)),e.add(`${n} ${i}`),e.add(`${n} ${r}`),c&&e.add(`${c} ${i}`),ge(r).forEach(l=>{e.add(l),e.add(`${n} ${l}`),c&&e.add(`${c} ${l}`)});const a=r.toLowerCase();return o.includes("date")&&(e.add("date"),e.add("date field"),a.includes("order")&&e.add("order date"),a.includes("warehouse")&&e.add("warehouse date")),(o.includes("numeric")||o.includes("measure"))&&(e.add("value"),e.add("amount"),e.add("measure"),a.includes("order")&&(e.add("order amount"),e.add("order value"))),o.includes("id")&&(e.add("id"),e.add("identifier"),a.includes("id")||e.add(`${i} id`),a.includes("order")&&e.add("order id"),a.includes("warehouse")&&e.add("warehouse id")),o.includes("status")&&(e.add("status"),e.add("state"),e.add("flag"),a.includes("order")&&e.add("order status"),a.includes("warehouse")&&e.add("warehouse status")),o.includes("entity")&&(e.add("customer"),e.add("client")),(a.includes("warehouse")||a.includes("whse"))&&(e.add("warehouse"),e.add("whse"),e.add("warehouse order")),(a.includes("mhir1")||a.includes("mhir"))&&(e.add("mhir1"),e.add("mhir"),e.add("confirmed by mhir1")),Array.from(e)}async function Ee(){return G(async t=>{const n=t.workbook,o=n.worksheets;o.load("items/name,items/visibility"),await t.sync();const e=[],s=Object.create(null);function i(a,l){let f=ce(a);f&&(s[f]?(s[f]+=1,f=`${f}__${s[f]}`):s[f]=1,e.push(`${f} = ${l}`))}for(const a of o.items){const l=a.visibility,f=l!=="Visible"?` (${l.toLowerCase()})`:"";e.push(`Sheet: ${a.name}${f}`);const m=a.getUsedRangeOrNullObject();if(m.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await t.sync(),m.isNullObject||m.rowCount<2||m.columnCount<1)continue;const y=Math.min(5,m.rowCount),M=a.getRangeByIndexes(m.rowIndex,m.columnIndex,y,m.columnCount);M.load("values");const N=Math.min(20,m.rowCount-y),k=N>0?a.getRangeByIndexes(m.rowIndex+y,m.columnIndex,N,m.columnCount):null;k&&k.load("values"),await t.sync();const K=M.values,X=k?k.values:[],$=m.rowIndex+y+1,Y=$+ae-1,J=m.rowIndex+m.rowCount-1+1,P=Math.min(Y,J);if(P<$)continue;const Z=a.name.replace(/'/g,"''");for(let u=0;u<m.columnCount;u++){const E=[];for(let h=0;h<y;h++){const b=K[h][u];b!=null&&b!==""&&E.push(String(b).trim())}if(!E.length)continue;const q=X.map(h=>h[u]!==void 0&&h[u]!==null?String(h[u]):""),O=D(E,q),g=W(E,a.name,O);if(!g.length)continue;const x=ie(m.columnIndex+u),I=`'${Z}'!${x}${$}:${x}${P}`;g.forEach(h=>i(h,I))}const A=a.tables;A.load("items/name"),await t.sync();const j=A.items.map(u=>({table:u,header:u.getHeaderRowRange()}));j.forEach(u=>u.header.load("values")),await t.sync();for(const{table:u,header:E}of j)e.push(`Table: ${u.name}`),(E.values&&E.values[0]||[]).forEach(O=>{if(!O)return;const g=String(O).trim();if(!g)return;const x=[u.name,g],I=D(x,[]),h=W(x,a.name,I);i(`${u.name}.${g}`,`${u.name}[${g}]`),h.forEach(b=>{i(`${u.name}.${b}`,`${u.name}[${g}]`)})});const U=a.pivotTables;U.load("items/name"),await t.sync(),U.items.forEach(u=>e.push(`PivotSource: ${u.name}`))}const r=n.names;r.load("items/name"),await t.sync();const c=[];for(const a of r.items){const l=a.getRange();l.load("address"),c.push({name:a.name,range:l})}await t.sync(),c.forEach(({name:a,range:l})=>{e.push(`NamedRange: ${a}`),i(a,l.address)});const d=e.join(`
`).slice(0,800);return console.log(`üîç Column map preview (INSANE+++):
`,d),e.join(`
`)})}async function _(t=!1){if(!R)try{const n=Date.now();if(!t&&v&&n-T<re){console.log("üîÑ Using cached Smart Column Map (recent)");return}R=!0,console.log("üîÑ Refreshing Smart Column Map‚Ä¶"),v=await Ee(),T=Date.now(),console.log("‚úÖ Updated Smart Column Map (INSANE+++)"),p("columnMap:updated",{columnMap:v})}catch(n){console.warn("Auto-refresh failed:",n),p("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{R=!1}}function F(){return v}H("workbook:changed",()=>{v="",T=0,console.log("üßπ Column map cache invalidated due to workbook change")});let C=null;function be(){return C||(C=document.createElement("div"),C.className="exwz-toast-container",Object.assign(C.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(C)),C}function w(t,n="info"){const o=be(),e=document.createElement("div");e.textContent=t,e.className="exwz-toast";const s={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},i={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(e.style,s,i[n]||i.info),o.appendChild(e),setTimeout(()=>e.remove(),2400)}const Ce=Object.freeze(Object.defineProperty({__proto__:null,showToast:w},Symbol.toStringTag,{value:"Module"}));function V(){var t;try{const n=new URLSearchParams(window.location.search);if(n.get("apiBase"))return n.get("apiBase");if((t=Office==null?void 0:Office.context)!=null&&t.roamingSettings){const o=Office.context.roamingSettings.get("excelwizpro_api_base");if(o)return o}}catch(n){console.warn("API base resolution error:",n)}return oe}let L="";async function xe(){const t=document.getElementById("sheetSelect"),n=document.getElementById("query"),o=document.getElementById("output"),e=document.getElementById("generateBtn"),s=document.getElementById("clearBtn"),i=document.getElementById("insertBtn");if(!t||!n||!o){console.error("‚ùå UI elements missing");return}await G(async r=>{const c=r.workbook.worksheets;c.load("items/name"),await r.sync(),t.innerHTML="",c.items.forEach(d=>{const a=document.createElement("option");a.value=d.name,a.textContent=d.name,t.appendChild(a)})}),await _(!0),H("ui:toast",({message:r,kind:c})=>w(r,c)),Se(V()),e.addEventListener("click",async()=>{const r=n.value.trim();if(!r){w("‚ö†Ô∏è Enter a request","warn");return}if(!navigator.onLine){w("üì¥ Offline","warn");return}e.disabled=!0,o.textContent="‚è≥ Generating‚Ä¶";try{await _(!1);let c=F();c||(await _(!0),c=F());const d=we(),a={query:r,columnMap:c,excelVersion:d,mainSheet:t.value},l=V();L=(await(await fetch(`${l}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json()).formula||'=ERROR("No formula returned")',o.textContent=L,w("‚úÖ Formula ready","success")}catch(c){console.error("Generation error:",c),o.textContent="‚ùå Error ‚Äî see details in console",w("‚ö†Ô∏è Formula generation failed","error")}finally{e.disabled=!1}}),s.addEventListener("click",()=>{o.textContent="",n.value=""}),i.addEventListener("click",async()=>{if(!L){w("‚ö†Ô∏è Nothing to insert","warn");return}try{await Excel.run(async r=>{const c=r.workbook.getSelectedRange();if(c.load("rowCount,columnCount"),await r.sync(),c.rowCount!==1||c.columnCount!==1){const d=new Error("MULTI_CELL_SELECTION");throw d.code="MULTI_CELL_SELECTION",d}c.formulas=[[L]],await r.sync()}),w("‚úÖ Inserted","success")}catch(r){(r==null?void 0:r.code)==="MULTI_CELL_SELECTION"?w("‚ö†Ô∏è Select a single cell","warn"):w("‚ö†Ô∏è Could not insert formula","error")}})}async function Se(t){try{(await fetch(`${t}/health`,{method:"GET"})).ok?p("backend:ready"):p("backend:error")}catch{p("backend:error")}}console.log(`üß† ExcelWizPro Taskpane v${ne} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function ve(){const t=await ue();return!await fe(t)||!await me()?!1:(await new Promise(n=>{document.readyState==="complete"||document.readyState==="interactive"?n():document.addEventListener("DOMContentLoaded",n)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await ve()){console.warn("Office not ready.");return}await he(),await xe();const{showToast:n}=await te(async()=>{const{showToast:o}=await Promise.resolve().then(()=>Ce);return{showToast:o}},void 0);n("‚úÖ ExcelWizPro ready!","success")})();
