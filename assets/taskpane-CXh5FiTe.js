(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();const G="modulepreload",K=function(e){return"/excelwizpro-frontend/"+e},M={},X=function(t,n,o){let a=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),c=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));a=Promise.allSettled(n.map(i=>{if(i=K(i),i in M)return;M[i]=!0;const u=i.endsWith(".css"),g=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${g}`))return;const m=document.createElement("link");if(m.rel=u?"stylesheet":G,u||(m.as="script"),m.crossOrigin="",m.href=i,c&&m.setAttribute("nonce",c),document.head.appendChild(m),u)return new Promise((b,L)=>{m.addEventListener("load",b),m.addEventListener("error",()=>L(new Error(`Unable to preload CSS for ${i}`)))})}))}function s(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return a.then(r=>{for(const c of r||[])c.status==="rejected"&&s(c.reason);return t().catch(s)})},J="13.0.0",Z="https://excelwizpro-backend.onrender.com",Q=90*1e3,Y=5e4;function ee(e){return new Promise(t=>setTimeout(t,e))}function te(e){let t=e+1,n="";for(;t>0;){const o=(t-1)%26;n=String.fromCharCode(65+o)+n,t=Math.floor((t-1)/26)}return n}function N(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}const C=new Map;function U(e,t){return C.has(e)||C.set(e,new Set),C.get(e).add(t),()=>ne(e,t)}function ne(e,t){const n=C.get(e);n&&n.delete(t)}function p(e,t){const n=C.get(e);if(n)for(const o of n)try{o(t)}catch(a){console.warn(`EventBus handler for '${e}' failed:`,a)}}function oe(){var e,t,n,o,a,s,r;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((n=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:n.platform)||"unknown",version:((a=(o=Office.context)==null?void 0:o.diagnostics)==null?void 0:a.version)||"unknown",build:((r=(s=Office.context)==null?void 0:s.diagnostics)==null?void 0:r.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function re(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const n=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(n),Office.onReady(e)),t>40&&(clearInterval(n),e({host:"unknown"}))},500)}})}async function ae(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),p("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function se(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async n=>{n.workbook.properties.load("title"),await n.sync()}),!0}catch{await ee(350+t*120)}return p("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function q(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),p("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function ie(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(n=>{try{const o=n.onChanged;o&&o.add&&o.add(async()=>{p("workbook:changed")})}catch(o){console.warn("Sheet change listener unsupported:",o)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function ce(){return oe().version||"unknown"}let k="",$=0,_=!1;function z(e){const n=String(e||"").trim().toLowerCase(),o=[];return/(warehouse|whse|location|region|area|zone|site|store|hub)/.test(n)&&o.push("category","location","warehouse"),/(type|status|state|stage|segment|class|category)/.test(n)&&o.push("category","status"),/(amount|value|total|qty|quantity|units|price|cost|sales|revenue|gmv|profit)/.test(n)&&o.push("measure","numeric"),/(date|day|month|year|week|period|timestamp|time)/.test(n)&&o.push("date","time"),/(flag|yes|no|true|false|confirm|verified|active|closed|complete)/.test(n)&&o.push("boolean","status"),/(name|description|title|comment|note)/.test(n)&&o.push("text","label"),/(id|code|key|ref|sku|number)/.test(n)&&o.push("id","identifier"),o.length===0&&o.push("unknown"),o.join(" ")}async function le(){return q(async e=>{const n=e.workbook.worksheets;n.load("items/name,items/visibility"),await e.sync();const o=[],a=Object.create(null);for(const s of n.items){const r=s.visibility,c=r!=="Visible"?` (${r.toLowerCase()})`:"";o.push(`Sheet: ${s.name}${c}`);const i=s.getUsedRangeOrNullObject();if(i.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),i.isNullObject||i.rowCount<2)continue;const u=Math.min(3,i.rowCount),g=s.getRangeByIndexes(i.rowIndex,i.columnIndex,u,i.columnCount);g.load("values");const m=s.tables;m.load("items/name");const b=s.pivotTables;b.load("items/name"),await e.sync();const L=g.values,D=i.rowIndex+u,W=i.rowIndex+i.rowCount-1,S=D+1,F=S+Y-1,V=W+1,T=Math.min(V,F);if(T>=S)for(let l=0;l<i.columnCount;l++){const h=[];for(let f=0;f<u;f++){const v=L[f][l];h[f]=v!==null&&v!==""&&v!==void 0?String(v).trim():""}let x="";for(let f=u-1;f>=0;f--)if(h[f]){x=h[f];break}if(!x)continue;let y=x;for(let f=0;f<u-1;f++)if(h[f]&&h[f]!==x){y=`${h[f]} - ${y}`;break}const I=z(y);let d=N(y);a[d]?(a[d]+=1,d=`${d}__${a[d]}`):a[d]=1;const P=te(i.columnIndex+l),H=s.name.replace(/'/g,"''");o.push(`${d} [semantic:${I}] = '${H}'!${P}${S}:${P}${T}`)}const B=m.items.map(l=>({table:l,header:l.getHeaderRowRange(),body:l.getDataBodyRange()}));B.forEach(l=>{l.header.load("values"),l.body.load("address,rowCount,columnCount")}),await e.sync();for(const{table:l,header:h}of B)o.push(`Table: ${l.name}`),(h.values&&h.values[0]||[]).forEach(y=>{if(!y)return;const I=z(y);let d=N(`${l.name}.${y}`);a[d]?(a[d]+=1,d=`${d}__${a[d]}`):a[d]=1,o.push(`${d} [semantic:${I}] = ${l.name}[${y}]`)});b.items.forEach(l=>o.push(`PivotSource: ${l.name}`))}return o.join(`
`)})}async function R(e=!1){if(!_)try{const t=Date.now();if(!e&&k&&t-$<Q)return;_=!0,k=await le(),$=Date.now(),p("columnMap:updated",{columnMap:k})}catch{p("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{_=!1}}function A(){return k}U("workbook:changed",()=>{k="",$=0});let E=null;function ue(){return E||(E=document.createElement("div"),E.className="exwz-toast-container",Object.assign(E.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(E)),E}function w(e,t="info"){const n=ue(),o=document.createElement("div");o.textContent=e,o.className="exwz-toast";const a={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},s={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(o.style,a,s[t]||s.info),n.appendChild(o),setTimeout(()=>o.remove(),2400)}const de=Object.freeze(Object.defineProperty({__proto__:null,showToast:w},Symbol.toStringTag,{value:"Module"}));function j(){var e;try{const t=new URLSearchParams(window.location.search);if(t.get("apiBase"))return t.get("apiBase");if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const n=Office.context.roamingSettings.get("excelwizpro_api_base");if(n)return n}}catch(t){console.warn("API base resolution error:",t)}return Z}let O="";async function fe(){const e=document.getElementById("sheetSelect"),t=document.getElementById("query"),n=document.getElementById("output"),o=document.getElementById("generateBtn"),a=document.getElementById("clearBtn"),s=document.getElementById("insertBtn");if(!e||!t||!n){console.error("‚ùå UI elements missing");return}await q(async r=>{const c=r.workbook.worksheets;c.load("items/name"),await r.sync(),e.innerHTML="",c.items.forEach(i=>{const u=document.createElement("option");u.value=i.name,u.textContent=i.name,e.appendChild(u)})}),await R(!0),U("ui:toast",({message:r,kind:c})=>w(r,c)),me(j()),o.addEventListener("click",async()=>{const r=t.value.trim();if(!r){w("‚ö†Ô∏è Enter a request","warn");return}if(!navigator.onLine){w("üì¥ Offline","warn");return}o.disabled=!0,n.textContent="‚è≥ Generating‚Ä¶";try{await R(!1);let c=A();c||(await R(!0),c=A());const i=ce(),u={query:r,columnMap:c,excelVersion:i,mainSheet:e.value},g=j();O=(await(await fetch(`${g}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)})).json()).formula||'=ERROR("No formula returned")',n.textContent=O,w("‚úÖ Formula ready","success")}catch(c){console.error("Generation error:",c),n.textContent="‚ùå Error ‚Äî see details in console",w("‚ö†Ô∏è Formula generation failed","error")}finally{o.disabled=!1}}),a.addEventListener("click",()=>{n.textContent="",t.value=""}),s.addEventListener("click",async()=>{if(!O){w("‚ö†Ô∏è Nothing to insert","warn");return}try{await Excel.run(async r=>{const c=r.workbook.getSelectedRange();if(c.load("rowCount,columnCount"),await r.sync(),c.rowCount!==1||c.columnCount!==1){const i=new Error("MULTI_CELL_SELECTION");throw i.code="MULTI_CELL_SELECTION",i}c.formulas=[[O]],await r.sync()}),w("‚úÖ Inserted","success")}catch(r){(r==null?void 0:r.code)==="MULTI_CELL_SELECTION"?w("‚ö†Ô∏è Select a single cell","warn"):w("‚ö†Ô∏è Could not insert formula","error")}})}async function me(e){try{(await fetch(`${e}/health`,{method:"GET"})).ok?p("backend:ready"):p("backend:error")}catch{p("backend:error")}}console.log(`üß† ExcelWizPro Taskpane v${J} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function we(){const e=await re();return!await ae(e)||!await se()?!1:(await new Promise(t=>{document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await we()){console.warn("Office not ready.");return}await ie(),await fe();const{showToast:t}=await X(async()=>{const{showToast:n}=await Promise.resolve().then(()=>de);return{showToast:n}},void 0);t("‚úÖ ExcelWizPro ready!","success")})();
