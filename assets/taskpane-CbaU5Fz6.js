(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const K="modulepreload",X=function(t){return"/excelwizpro-frontend/"+t},A={},Z=function(e,n,a){let s=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),c=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=Promise.allSettled(n.map(l=>{if(l=X(l),l in A)return;A[l]=!0;const o=l.endsWith(".css"),u=o?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const d=document.createElement("link");if(d.rel=o?"stylesheet":K,o||(d.as="script"),d.crossOrigin="",d.href=l,c&&d.setAttribute("nonce",c),document.head.appendChild(d),o)return new Promise((m,E)=>{d.addEventListener("load",m),d.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return s.then(r=>{for(const c of r||[])c.status==="rejected"&&i(c.reason);return e().catch(i)})},J="13.0.0",Q="https://excelwizpro-backend.onrender.com",Y=90*1e3,ee=5e4;function te(t){return new Promise(e=>setTimeout(e,t))}function ne(t){let e=t+1,n="";for(;e>0;){const a=(e-1)%26;n=String.fromCharCode(65+a)+n,e=Math.floor((e-1)/26)}return n}function oe(t){return String(t||"").trim().toLowerCase().replace(/\s+/g,"_")}const C=new Map;function D(t,e){return C.has(t)||C.set(t,new Set),C.get(t).add(e),()=>re(t,e)}function re(t,e){const n=C.get(t);n&&n.delete(e)}function w(t,e){const n=C.get(t);if(n)for(const a of n)try{a(e)}catch(s){console.warn(`EventBus handler for '${t}' failed:`,s)}}function ae(){var t,e,n,a,s,i,r;try{return{host:((t=Office.context)==null?void 0:t.host)||"unknown",platform:((n=(e=Office.context)==null?void 0:e.diagnostics)==null?void 0:n.platform)||"unknown",version:((s=(a=Office.context)==null?void 0:a.diagnostics)==null?void 0:s.version)||"unknown",build:((r=(i=Office.context)==null?void 0:i.diagnostics)==null?void 0:r.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function se(){return new Promise(t=>{if(window.Office&&Office.onReady)Office.onReady(t);else{let e=0;const n=setInterval(()=>{e++,window.Office&&Office.onReady&&(clearInterval(n),Office.onReady(t)),e>40&&(clearInterval(n),t({host:"unknown"}))},500)}})}async function ce(t){return!t||t.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",t&&t.host),w("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function ie(t=20){for(let e=1;e<=t;e++)try{return await Excel.run(async n=>{n.workbook.properties.load("title"),await n.sync()}),!0}catch{await te(350+e*120)}return w("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function q(t){try{return await Excel.run(t)}catch(e){throw console.warn("Excel.run failed:",e),w("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),e}}async function le(){try{await Excel.run(async t=>{const e=t.workbook.worksheets;e.load("items/name"),await t.sync(),e.items.forEach(n=>{try{const a=n.onChanged;a&&a.add&&a.add(async()=>{w("workbook:changed")})}catch(a){console.warn("Sheet change listener unsupported:",a)}})})}catch(t){console.warn("Workbook change listeners failed:",t)}}function de(){return ae().version||"unknown"}let k="",T=0,R=!1;function U(t){const e=new Set,n=t.map(o=>(o||"").trim()).filter(Boolean);if(n.length===0)return[];const a=n[n.length-1];let s=a;for(let o=0;o<n.length-1;o++){const u=n[o];if(u&&u!==a){s=`${u} - ${s}`;break}}e.add(s),e.add(a);for(const o of n)e.add(o);const i=new Set,r=/[^a-zA-Z0-9]+/;for(const o of n){const u=o.toLowerCase().split(r).map(d=>d.trim()).filter(d=>d.length>1);for(const d of u)i.add(d)}for(const o of i)e.add(o);const c=Array.from(i);for(let o=0;o<c.length-1;o++)e.add(`${c[o]} ${c[o+1]}`);const l=n.join(" ").toLowerCase();return(l.includes("warehouse")||l.includes("whse"))&&(e.add("warehouse"),e.add("whse"),e.add("warehouse order")),l.includes("order")&&(e.add("order"),e.add("order id")),(l.includes("mhir1")||l.includes("mhir"))&&(e.add("mhir1"),e.add("mhir"),e.add("confirmed by mhir1")),l.includes("confirm")&&(e.add("confirmed"),e.add("confirmed flag"),e.add("confirmation status")),l.includes("status")&&(e.add("status"),e.add("order status")),l.includes("date")&&(e.add("date"),e.add("order date")),l.includes("id")&&e.add("id"),Array.from(e)}async function ue(){return q(async t=>{const e=t.workbook,n=e.worksheets;n.load("items/name,items/visibility"),await t.sync();const a=[],s=Object.create(null);function i(o,u){let d=oe(o);d&&(s[d]?(s[d]+=1,d=`${d}__${s[d]}`):s[d]=1,a.push(`${d} = ${u}`))}for(const o of n.items){const u=o.visibility,d=u!=="Visible"?` (${u.toLowerCase()})`:"";a.push(`Sheet: ${o.name}${d}`);const m=o.getUsedRangeOrNullObject();if(m.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await t.sync(),m.isNullObject||m.rowCount<2)continue;const E=Math.min(3,m.rowCount),_=o.getRangeByIndexes(m.rowIndex,m.columnIndex,E,m.columnCount);_.load("values");const B=o.tables;B.load("items/name");const M=o.pivotTables;M.load("items/name"),await t.sync();const W=_.values,F=m.rowIndex+E,V=m.rowIndex+m.rowCount-1,v=F+1,H=v+ee-1,G=V+1,P=Math.min(G,H);if(P>=v)for(let f=0;f<m.columnCount;f++){const b=[];for(let g=0;g<E;g++){const O=W[g][f];b[g]=O!==null&&O!==""&&O!==void 0?String(O).trim():""}const L=U(b);if(!L.length)continue;const x=ne(m.columnIndex+f),I=`'${o.name.replace(/'/g,"''")}'!${x}${v}:${x}${P}`;for(const g of L)i(g,I)}const N=B.items.map(f=>({table:f,header:f.getHeaderRowRange(),body:f.getDataBodyRange()}));N.forEach(f=>{f.header.load("values"),f.body.load("address,rowCount,columnCount")}),await t.sync();for(const{table:f,header:b}of N)a.push(`Table: ${f.name}`),(b.values&&b.values[0]||[]).forEach(x=>{if(!x)return;const p=String(x).trim();if(!p)return;i(`${f.name}.${p}`,`${f.name}[${p}]`);const I=U([p]);for(const g of I)i(`${f.name}.${g}`,`${f.name}[${p}]`)});M.items.forEach(f=>a.push(`PivotSource: ${f.name}`))}const r=e.names;r.load("items/name"),await t.sync();const c=[];for(const o of r.items){const u=o.getRange();u.load("address"),c.push({name:o.name,range:u})}await t.sync(),c.forEach(({name:o,range:u})=>{a.push(`NamedRange: ${o}`),i(o,u.address)});const l=a.join(`
`);return console.log(`üîç Column map built (first 800 chars):
`,l.slice(0,800)),l})}async function $(t=!1){if(!R)try{const e=Date.now();if(!t&&k&&e-T<Y){console.log("üîÑ Using cached Smart Column Map (recent)");return}R=!0,console.log("üîÑ Refreshing Smart Column Map‚Ä¶"),k=await ue(),T=Date.now(),console.log("‚úÖ Updated Smart Column Map"),w("columnMap:updated",{columnMap:k})}catch(e){console.warn("Auto-refresh failed:",e),w("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{R=!1}}function j(){return k}D("workbook:changed",()=>{k="",T=0,console.log("üßπ Column map cache invalidated due to workbook change")});let y=null;function fe(){return y||(y=document.createElement("div"),y.className="exwz-toast-container",Object.assign(y.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(y)),y}function h(t,e="info"){const n=fe(),a=document.createElement("div");a.textContent=t,a.className="exwz-toast";const s={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},i={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(a.style,s,i[e]||i.info),n.appendChild(a),setTimeout(()=>a.remove(),2400)}const me=Object.freeze(Object.defineProperty({__proto__:null,showToast:h},Symbol.toStringTag,{value:"Module"}));function z(){var t;try{const e=new URLSearchParams(window.location.search);if(e.get("apiBase"))return e.get("apiBase");if((t=Office==null?void 0:Office.context)!=null&&t.roamingSettings){const n=Office.context.roamingSettings.get("excelwizpro_api_base");if(n)return n}}catch(e){console.warn("API base resolution error:",e)}return Q}let S="";async function he(){const t=document.getElementById("sheetSelect"),e=document.getElementById("query"),n=document.getElementById("output"),a=document.getElementById("generateBtn"),s=document.getElementById("clearBtn"),i=document.getElementById("insertBtn");if(!t||!e||!n){console.error("‚ùå UI elements missing");return}await q(async r=>{const c=r.workbook.worksheets;c.load("items/name"),await r.sync(),t.innerHTML="",c.items.forEach(l=>{const o=document.createElement("option");o.value=l.name,o.textContent=l.name,t.appendChild(o)})}),await $(!0),D("ui:toast",({message:r,kind:c})=>h(r,c)),we(z()),a.addEventListener("click",async()=>{const r=e.value.trim();if(!r){h("‚ö†Ô∏è Enter a request","warn");return}if(!navigator.onLine){h("üì¥ Offline","warn");return}a.disabled=!0,n.textContent="‚è≥ Generating‚Ä¶";try{await $(!1);let c=j();c||(await $(!0),c=j());const l=de(),o={query:r,columnMap:c,excelVersion:l,mainSheet:t.value},u=z();S=(await(await fetch(`${u}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json()).formula||'=ERROR("No formula returned")',n.textContent=S,h("‚úÖ Formula ready","success")}catch(c){console.error("Generation error:",c),n.textContent="‚ùå Error ‚Äî see details in console",h("‚ö†Ô∏è Formula generation failed","error")}finally{a.disabled=!1}}),s.addEventListener("click",()=>{n.textContent="",e.value=""}),i.addEventListener("click",async()=>{if(!S){h("‚ö†Ô∏è Nothing to insert","warn");return}try{await Excel.run(async r=>{const c=r.workbook.getSelectedRange();if(c.load("rowCount,columnCount"),await r.sync(),c.rowCount!==1||c.columnCount!==1){const l=new Error("MULTI_CELL_SELECTION");throw l.code="MULTI_CELL_SELECTION",l}c.formulas=[[S]],await r.sync()}),h("‚úÖ Inserted","success")}catch(r){(r==null?void 0:r.code)==="MULTI_CELL_SELECTION"?h("‚ö†Ô∏è Select a single cell","warn"):h("‚ö†Ô∏è Could not insert formula","error")}})}async function we(t){try{(await fetch(`${t}/health`,{method:"GET"})).ok?w("backend:ready"):w("backend:error")}catch{w("backend:error")}}console.log(`üß† ExcelWizPro Taskpane v${J} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function ge(){const t=await se();return!await ce(t)||!await ie()?!1:(await new Promise(e=>{document.readyState==="complete"||document.readyState==="interactive"?e():document.addEventListener("DOMContentLoaded",e)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await ge()){console.warn("Office not ready.");return}await le(),await he();const{showToast:e}=await Z(async()=>{const{showToast:n}=await Promise.resolve().then(()=>me);return{showToast:n}},void 0);e("‚úÖ ExcelWizPro ready!","success")})();
