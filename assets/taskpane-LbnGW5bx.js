(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();const H="modulepreload",K=function(e){return"/excelwizpro-frontend/"+e},M={},X=function(t,n,r){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),s=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));o=Promise.allSettled(n.map(l=>{if(l=K(l),l in M)return;M[l]=!0;const i=l.endsWith(".css"),w=i?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${w}`))return;const u=document.createElement("link");if(u.rel=i?"stylesheet":H,i||(u.as="script"),u.crossOrigin="",u.href=l,s&&u.setAttribute("nonce",s),document.head.appendChild(u),i)return new Promise((f,x)=>{u.addEventListener("load",f),u.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${l}`)))})}))}function c(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return o.then(a=>{for(const s of a||[])s.status==="rejected"&&c(s.reason);return t().catch(c)})},G="13.0.0",Q="https://excelwizpro-backend.onrender.com",J=90*1e3,Z=5e4,Y=2e4,ee=3;function F(e){return new Promise(t=>setTimeout(t,e))}function te(e){let t=e+1,n="";for(;t>0;){const r=(t-1)%26;n=String.fromCharCode(65+r)+n,t=Math.floor((t-1)/26)}return n}function L(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}function ne(){try{return Object.fromEntries(new URLSearchParams(window.location.search))}catch{return{}}}const C=new Map;function N(e,t){return C.has(e)||C.set(e,new Set),C.get(e).add(t),()=>oe(e,t)}function oe(e,t){const n=C.get(e);n&&n.delete(t)}function g(e,t){const n=C.get(e);if(n)for(const r of n)try{r(t)}catch(o){console.warn(`EventBus handler for '${e}' failed:`,o)}}function re(){var e,t,n,r,o,c,a;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((n=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:n.platform)||"unknown",version:((o=(r=Office.context)==null?void 0:r.diagnostics)==null?void 0:o.version)||"unknown",build:((a=(c=Office.context)==null?void 0:c.diagnostics)==null?void 0:a.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function ae(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const n=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(n),Office.onReady(e)),t>40&&(clearInterval(n),e({host:"unknown"}))},500)}})}async function se(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),g("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function ce(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async n=>{n.workbook.properties.load("title"),await n.sync()}),!0}catch{await F(350+t*120)}return g("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function U(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),g("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function ie(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(n=>{try{const r=n.onChanged;r&&r.add&&r.add(async()=>{g("workbook:changed")})}catch(r){console.warn("Sheet change listener unsupported:",r)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function le(){return re().version||"unknown"}let k="",R=0,I=!1;async function ue(){return U(async e=>{var l;const t=e.workbook,n=t.worksheets;n.load("items/name,items/visibility"),await e.sync();const r=[],o=Object.create(null);for(const i of n.items){const w=i.visibility,u=w!=="Visible"?` (${w.toLowerCase()})`:"";r.push(`Sheet: ${i.name}${u}`);const f=i.getUsedRangeOrNullObject();if(f.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),f.isNullObject||f.rowCount<1)continue;const x=i.getRangeByIndexes(f.rowIndex,f.columnIndex,1,f.columnCount);x.load("values");const T=i.tables;T.load("items/name");const $=i.pivotTables;$.load("items/name"),await e.sync();const D=x.values,S=2,W=f.rowIndex+f.rowCount,q=S+Z,B=Math.min(W,q);if(B>=S)for(let d=0;d<f.columnCount;d++){const O=String(D[0][d]??"").trim();if(!O)continue;let y=L(O);o[y]?(o[y]+=1,y=`${y}__${o[y]}`):o[y]=1;const p=te(f.columnIndex+d),h=i.name.replace(/'/g,"''");r.push(`${y} = '${h}'!${p}${S}:${p}${B}`)}const P=T.items.map(d=>({table:d,header:d.getHeaderRowRange(),body:d.getDataBodyRange()}));P.forEach(d=>{d.header.load("values"),d.body.load("address,rowCount,columnCount")}),await e.sync();for(const{table:d,header:O}of P)r.push(`Table: ${d.name}`),(((l=O.values)==null?void 0:l[0])||[]).forEach(p=>{if(!p)return;let h=L(`${d.name}.${p}`);o[h]?(o[h]+=1,h=`${h}__${o[h]}`):o[h]=1;const V=`${d.name}[${p}]`;r.push(`${h} = ${V}`)});$.items.forEach(d=>r.push(`PivotSource: ${d.name}`))}const c=t.names;c.load("items/name"),await e.sync();const a=[];for(const i of c.items){const w=i.getRange();w.load("address"),a.push({name:i.name,range:w})}await e.sync(),a.forEach(({name:i,range:w})=>{r.push(`NamedRange: ${i}`);let u=L(i);o[u]?(o[u]+=1,u=`${u}__${o[u]}`):o[u]=1,r.push(`${u} = ${w.address}`)});const s=r.join(`
`).slice(0,600);return console.log(`üîç Column map preview (v15.4 forced row2):
`,s),r.join(`
`)})}async function _(e=!1){if(!I)try{const t=Date.now();if(!e&&k&&t-R<J){console.log("üîÑ Using cached Smart Column Map (recent)");return}I=!0,console.log("üîÑ Refreshing Smart Column Map (v15.4)..."),k=await ue(),R=Date.now(),console.log("‚úÖ Updated Smart Column Map (v15.4)"),g("columnMap:updated",{columnMap:k})}catch(t){console.warn("Auto-refresh failed:",t),g("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{I=!1}}function A(){return k}N("workbook:changed",()=>{k="",R=0,console.log("üßπ Column map cache invalidated due to workbook change")});function de(e){if(typeof AbortController>"u")return;const t=new AbortController,n=setTimeout(()=>t.abort(),e);return t.signal.addEventListener("abort",()=>clearTimeout(n)),t.signal}async function fe(e,{timeout:t=Y,...n}={}){if(!navigator.onLine){const o=new Error("offline");throw o.code="OFFLINE",o}const r=n.signal||de(t);return fetch(e,{...n,signal:r})}async function j(e,t={}){let n=null;for(let r=1;r<=ee;r++){try{const o=await fe(e,t);if(!o.ok){n=new Error(`HTTP ${o.status}`),n.status=o.status;continue}return o}catch(o){n=o,o.name==="AbortError"||o.code}await F(300*r)}throw n||new Error("fetchWithRetry failed")}let b=Q;function z(){var e;try{const t=ne();if(t.apiBase)return b=t.apiBase,b;if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const n=Office.context.roamingSettings.get("excelwizpro_api_base");if(n)return b=n,b}}catch(t){console.warn("API base resolution error:",t)}return b}async function me(e=5){const t=document.querySelector("main.container"),n=document.createElement("div");Object.assign(n.style,{padding:"6px",marginBottom:"8px",borderRadius:"6px",fontSize:"0.9rem",textAlign:"center"}),t&&t.prepend(n);const r=z();for(let o=1;o<=e;o++){try{if((await j(`${r}/health`,{timeout:4e3})).ok){n.textContent="‚úÖ Backend ready",n.style.background="#e6ffed",n.style.color="#0c7a0c",setTimeout(()=>n.remove(),2e3),g("backend:ready");return}}catch{}n.textContent=`‚è≥ Waking backend‚Ä¶ (${o}/${e})`,n.style.background="#fff4ce",n.style.color="#976f00"}n.textContent="‚ùå Backend unreachable",n.style.background="#fde7e9",n.style.color="#c22",g("backend:error")}async function we(e){const t=z();try{return(await(await j(`${t}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"})).json()).formula||'=ERROR("No formula returned")'}catch(n){throw console.error("‚ùå Backend /generate failed:",n),g("ui:toast",{message:"‚ö†Ô∏è Could not reach formula engine",kind:"error"}),n}}let E=null;function he(){return E||(E=document.createElement("div"),E.className="exwz-toast-container",Object.assign(E.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(E)),E}function m(e,t="info"){const n=he(),r=document.createElement("div");r.textContent=e,r.className="exwz-toast";const o={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},c={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(r.style,o,c[t]||c.info),n.appendChild(r),setTimeout(()=>r.remove(),2400)}const ge=Object.freeze(Object.defineProperty({__proto__:null,showToast:m},Symbol.toStringTag,{value:"Module"}));let v="";async function ye(){const e=document.getElementById("sheetSelect"),t=document.getElementById("query"),n=document.getElementById("output"),r=document.getElementById("generateBtn"),o=document.getElementById("clearBtn"),c=document.getElementById("insertBtn");if(!e||!t||!n){console.error("‚ùå UI elements missing");return}await U(async a=>{const s=a.workbook.worksheets;s.load("items/name"),await a.sync(),e.innerHTML="",s.items.forEach(l=>{const i=document.createElement("option");i.value=l.name,i.textContent=l.name,e.appendChild(i)})}),await _(!0),N("ui:toast",({message:a,kind:s})=>m(a,s)),me(),r.addEventListener("click",async()=>{const a=t.value.trim();if(!a){m("‚ö†Ô∏è Enter a request","warn");return}if(!navigator.onLine){m("üì¥ Offline","warn");return}r.disabled=!0,n.textContent="‚è≥ Generating‚Ä¶";try{await _(!1);let s=A();s||(await _(!0),s=A());const l=le(),i={query:a,columnMap:s,excelVersion:l,mainSheet:e.value};v=await we(i),n.textContent=v,m("‚úÖ Formula ready","success")}catch(s){console.error("Generation error:",s),n.textContent="‚ùå Error ‚Äî check console",m("‚ö†Ô∏è Formula generation failed","error")}finally{r.disabled=!1}}),o.addEventListener("click",()=>{n.textContent="",t.value=""}),c.addEventListener("click",async()=>{if(!v){m("‚ö†Ô∏è Nothing to insert","warn");return}let a=v.replace(/^[\u200B\u200C\u200D\u200E\u200F\uFEFF\u00A0']+/,"").replace(/[\u200B\u200C\u200D\u200E\u200F\uFEFF\u00A0]/g,"").replace(/\r?\n/g,"").trim();a.startsWith("=")||(a="="+a);try{await Excel.run(async s=>{const l=s.workbook.getSelectedRange();if(l.load("rowCount,columnCount"),await s.sync(),l.rowCount!==1||l.columnCount!==1){const i=new Error("MULTI_CELL_SELECTION");throw i.code="MULTI_CELL_SELECTION",i}l.formulas=[[a]],await s.sync()}),m("‚úÖ Inserted","success")}catch(s){console.error("Insert error:",s),(s==null?void 0:s.code)==="MULTI_CELL_SELECTION"?m("‚ö†Ô∏è Select a single cell","warn"):m("‚ö†Ô∏è Could not insert formula","error")}})}console.log(`üß† ExcelWizPro Taskpane v${G} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function pe(){const e=await ae();return!await se(e)||!await ce()?!1:(await new Promise(t=>{document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await pe()){console.warn("Office not ready.");return}await ie(),await ye();const{showToast:t}=await X(async()=>{const{showToast:n}=await Promise.resolve().then(()=>ge);return{showToast:n}},void 0);t("‚úÖ ExcelWizPro ready!","success")})();
