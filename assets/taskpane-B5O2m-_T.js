(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();let d="",y="",k=0,b=!1;const T=90*1e3,j=5e4;Office.onReady(async()=>{console.log("ExcelWizPro ready."),await U(),await M(!0),V(),W()});function O(e){return String(e||"").trim().toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g,"_").replace(/^_+|_+$/g,"")||"col"}function q(e){let t=e+1,o="";for(;t>0;){const r=(t-1)%26;o=String.fromCharCode(65+r)+o,t=Math.floor((t-1)/26)}return o}function A(){var e,t;try{return((t=(e=Office.context)==null?void 0:e.diagnostics)==null?void 0:t.version)||"unknown"}catch{return"unknown"}}async function F(){return Excel.run(async e=>{const t=e.workbook,o=t.worksheets;o.load("items/name,items/visibility"),await e.sync();const r=[],n=Object.create(null);function s(a){let u=a;return n[a]?(n[a]+=1,u=`${a}__${n[a]}`):n[a]=1,u}for(const a of o.items){const u=a.name,g=a.visibility||"Visible",S=g!=="Visible"?` (${g.toLowerCase()})`:"";r.push(`Sheet: ${u}${S}`);const i=a.getUsedRangeOrNullObject();if(i.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),i.isNullObject||i.rowCount<2||i.columnCount<1)continue;const f=Math.min(3,i.rowCount),I=a.getRangeByIndexes(i.rowIndex,i.columnIndex,f,i.columnCount);I.load("values"),await e.sync();const $=I.values,B=i.rowIndex+f,x=i.rowIndex+i.rowCount-1,C=Math.min(B+1,x+1),R=Math.min(C+j-1,x+1);if(!(R<C))for(let p=0;p<i.columnCount;p++){const m=[];for(let c=0;c<f;c++){const w=$[c][p];m[c]=w===null||w===""||w===void 0?"":String(w).trim()}let h="";for(let c=f-1;c>=0;c--)if(m[c]){h=m[c];break}if(!h)continue;let v=h;for(let c=0;c<f-1;c++)if(m[c]&&m[c]!==h){v=`${m[c]} - ${h}`;break}const N=O(v),_=s(N),L=q(i.columnIndex+p),P=`'${u.replace(/'/g,"''")}'!${L}${C}:${L}${R}`;r.push(`${_} = ${P}`)}}const l=t.names;l.load("items/name"),await e.sync();const E=[];for(const a of l.items){const u=a.getRange();u.load("address"),E.push({name:a.name,address:u})}await e.sync();for(const a of E){const u=O(a.name),g=s(u);r.push(`NamedRange: ${a.name}`),r.push(`${g} = ${a.address.address}`)}return r.join(`
`)})}async function M(e=!1){const t=Date.now();if(!e&&y&&t-k<T)return y;if(b)return await new Promise(o=>setTimeout(o,400)),y;try{b=!0;const o=await F();return y=o,k=Date.now(),console.log("Column map refreshed."),o}catch(o){return console.error("Column map build failed:",o),""}finally{b=!1}}function W(){try{Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(o=>{try{const r=o.onChanged;r&&r.add&&r.add(async()=>{y="",k=0,console.log("Workbook changed – column map cache cleared.")})}catch(r){console.warn("Could not attach change listener:",r)}})})}catch(e){console.warn("Workbook listener init failed:",e)}}async function U(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync();const o=document.getElementById("sheetSelect");o.innerHTML="",t.items.forEach(r=>{const n=document.createElement("option");n.value=r.name,n.textContent=r.name,o.appendChild(n)})})}catch(e){console.error("Sheet load error:",e)}}function V(){document.getElementById("generateBtn").addEventListener("click",z),document.getElementById("clearBtn").addEventListener("click",D),document.getElementById("insertBtn").addEventListener("click",G)}async function z(){const e=document.getElementById("query").value.trim(),t=document.getElementById("output"),o=document.getElementById("sheetSelect").value;if(!e){t.textContent="⚠️ Please enter a request.";return}t.textContent="⏳ Building column map...";const r=await M(!1);if(!r){t.textContent="❌ Could not build a column map from this workbook. Check that your data has headers and visible sheets.",d="";return}t.textContent="⏳ Generating formula...";try{const s=await(await fetch("https://excelwizpro-backend.onrender.com/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,mainSheet:o,columnMap:r,excelVersion:A()})})).json();if(s.error){t.textContent="❌ "+s.error,d="";return}const l=s.formula;if(!l){t.textContent="❌ No formula returned.",d="";return}if(/^=ERROR\("Missing input"\)/i.test(l)){t.textContent="⚠️ The AI couldn't find enough context in your workbook (missing column map or data). Try checking your headers, selecting the correct sheet, and rephrasing your request.",d="";return}d=l,t.textContent=l}catch(n){t.textContent="❌ Backend is unreachable.",console.error(n)}}function D(){document.getElementById("query").value="",document.getElementById("output").textContent="",d=""}async function G(){if(!d){alert("⚠️ Generate a formula first.");return}try{await Excel.run(async e=>{const t=e.workbook.getSelectedRange();t.formulas=[[d]],await e.sync()}),alert("Formula inserted!")}catch(e){console.error("Insert error:",e),alert("⚠️ Select a single cell first.")}}
