(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const W="modulepreload",q=function(e,t){return new URL(e,t).href},M={},V=function(t,n,r){let o=Promise.resolve();if(n&&n.length>0){const s=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),u=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));o=Promise.allSettled(n.map(i=>{if(i=q(i,r),i in M)return;M[i]=!0;const d=i.endsWith(".css"),f=d?'[rel="stylesheet"]':"";if(!!r)for(let p=s.length-1;p>=0;p--){const b=s[p];if(b.href===i&&(!d||b.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${i}"]${f}`))return;const g=document.createElement("link");if(g.rel=d?"stylesheet":W,d||(g.as="script"),g.crossOrigin="",g.href=i,u&&g.setAttribute("nonce",u),document.head.appendChild(g),d)return new Promise((p,b)=>{g.addEventListener("load",p),g.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${i}`)))})}))}function a(s){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s}return o.then(s=>{for(const c of s||[])c.status==="rejected"&&a(c.reason);return t().catch(a)})},H="13.0.0",J="https://excelwizpro-backend.onrender.com",G=90*1e3,K=5e4;function X(e){return new Promise(t=>setTimeout(t,e))}function Z(e){let t=e+1,n="";for(;t>0;){const r=(t-1)%26;n=String.fromCharCode(65+r)+n,t=Math.floor((t-1)/26)}return n}function $(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}const v=new Map;function A(e,t){return v.has(e)||v.set(e,new Set),v.get(e).add(t),()=>Q(e,t)}function Q(e,t){const n=v.get(e);n&&n.delete(t)}function w(e,t){const n=v.get(e);if(n)for(const r of n)try{r(t)}catch(o){console.warn(`EventBus handler for '${e}' failed:`,o)}}function Y(){var e,t,n,r,o,a,s;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((n=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:n.platform)||"unknown",version:((o=(r=Office.context)==null?void 0:r.diagnostics)==null?void 0:o.version)||"unknown",build:((s=(a=Office.context)==null?void 0:a.diagnostics)==null?void 0:s.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function ee(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const n=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(n),Office.onReady(e)),t>40&&(clearInterval(n),e({host:"unknown"}))},500)}})}async function te(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),w("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function ne(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async n=>{n.workbook.properties.load("title"),await n.sync()}),!0}catch{await X(350+t*120)}return w("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function j(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),w("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function oe(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(n=>{try{const r=n.onChanged;r&&r.add&&r.add(async()=>{w("workbook:changed")})}catch(r){console.warn("Sheet change listener unsupported:",r)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function re(){return Y().version||"unknown"}let O="",_=0,I=!1;async function ae(){return j(async e=>{var u;const t=e.workbook,n=t.worksheets;n.load("items/name,items/visibility"),await e.sync();const r=[],o=Object.create(null);for(const i of n.items){const d=i.visibility,f=d!=="Visible"?` (${d.toLowerCase()})`:"";r.push(`Sheet: ${i.name}${f}`);const m=i.getUsedRangeOrNullObject();if(m.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),m.isNullObject||m.rowCount<1)continue;const g=i.getRangeByIndexes(m.rowIndex,m.columnIndex,1,m.columnCount);g.load("values");const p=i.tables;p.load("items/name");const b=i.pivotTables;b.load("items/name"),await e.sync();const U=g.values,R=2,z=m.rowIndex+m.rowCount,F=R+K,B=Math.min(z,F);if(B>=R)for(let l=0;l<m.columnCount;l++){const S=String(U[0][l]??"").trim();if(!S)continue;let y=$(S);o[y]?(o[y]+=1,y=`${y}__${o[y]}`):o[y]=1;const C=Z(m.columnIndex+l),h=i.name.replace(/'/g,"''");r.push(`${y} = '${h}'!${C}${R}:${C}${B}`)}const P=p.items.map(l=>({table:l,header:l.getHeaderRowRange(),body:l.getDataBodyRange()}));P.forEach(l=>{l.header.load("values"),l.body.load("address,rowCount,columnCount")}),await e.sync();for(const{table:l,header:S}of P)r.push(`Table: ${l.name}`),(((u=S.values)==null?void 0:u[0])||[]).forEach(C=>{if(!C)return;let h=$(`${l.name}.${C}`);o[h]?(o[h]+=1,h=`${h}__${o[h]}`):o[h]=1;const D=`${l.name}[${C}]`;r.push(`${h} = ${D}`)});b.items.forEach(l=>r.push(`PivotSource: ${l.name}`))}const a=t.names;a.load("items/name"),await e.sync();const s=[];for(const i of a.items){const d=i.getRange();d.load("address"),s.push({name:i.name,range:d})}await e.sync(),s.forEach(({name:i,range:d})=>{r.push(`NamedRange: ${i}`);let f=$(i);o[f]?(o[f]+=1,f=`${f}__${o[f]}`):o[f]=1,r.push(`${f} = ${d.address}`)});const c=r.join(`
`).slice(0,600);return console.log(`üîç Column map preview (v15.4 forced row2):
`,c),r.join(`
`)})}async function L(e=!1){if(!I)try{const t=Date.now();if(!e&&O&&t-_<G){console.log("üîÑ Using cached Smart Column Map (recent)");return}I=!0,console.log("üîÑ Refreshing Smart Column Map (v15.4)..."),O=await ae(),_=Date.now(),console.log("‚úÖ Updated Smart Column Map (v15.4)"),w("columnMap:updated",{columnMap:O})}catch(t){console.warn("Auto-refresh failed:",t),w("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{I=!1}}function T(){return O}A("workbook:changed",()=>{O="",_=0,console.log("üßπ Column map cache invalidated due to workbook change")});let k=null;function se(){return k||(k=document.createElement("div"),k.className="exwz-toast-container",Object.assign(k.style,{position:"fixed",bottom:"14px",right:"14px",zIndex:99999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px",pointerEvents:"none"}),document.body.appendChild(k)),k}function E(e,t="info"){const n=se(),r=document.createElement("div");r.textContent=e,r.className="exwz-toast";const o={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",fontFamily:"Inter, sans-serif",boxShadow:"0 2px 10px rgba(0,0,0,0.25)",pointerEvents:"auto"},a={info:{background:"#e5f1ff",color:"#084f94"},success:{background:"#e6ffed",color:"#0c7a0c"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"}};Object.assign(r.style,o,a[t]||a.info),n.appendChild(r),setTimeout(()=>r.remove(),2400)}const ce=Object.freeze(Object.defineProperty({__proto__:null,showToast:E},Symbol.toStringTag,{value:"Module"}));let x="";function N(){var e;try{const t=new URLSearchParams(window.location.search);if(t.get("apiBase"))return t.get("apiBase");if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const n=Office.context.roamingSettings.get("excelwizpro_api_base");if(n)return n}}catch(t){console.warn("API base resolution error:",t)}return J}function ie(e){if(typeof e!="string")return"";let t=e.replace(/[\u200B\u200C\u200D\u200E\u200F\uFEFF\u00A0]/g,"").replace(/[\r\n\t]+/g," ").replace(/ {2,}/g," ").replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äò‚Äô]/g,"'").replace(/√ó/g,"*").replace(/√∑/g,"/").replace(/[‚Äì‚Äî‚àí]/g,"-").replace(/\\/g,"").trim();return t.startsWith("=")||(t="="+t),t}async function le(){const e=document.getElementById("sheetSelect"),t=document.getElementById("query"),n=document.getElementById("output"),r=document.getElementById("generateBtn");document.getElementById("clearBtn");const o=document.getElementById("insertBtn");if(!e||!t||!n){console.error("‚ùå UI elements missing");return}await j(async a=>{const s=a.workbook.worksheets;s.load("items/name"),await a.sync(),e.innerHTML="",s.items.forEach(c=>{const u=document.createElement("option");u.value=c.name,u.textContent=c.name,e.appendChild(u)})}),await L(!0),A("ui:toast",({message:a,kind:s})=>E(a,s)),ue(N()),r.addEventListener("click",async()=>{const a=t.value.trim();if(!a)return E("‚ö†Ô∏è Enter a request","warn");r.disabled=!0,n.textContent="‚è≥ Generating‚Ä¶";try{await L(!1);let s=T();s||(await L(!0),s=T());const c=re(),u=N();x=(await(await fetch(`${u}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:a,columnMap:s,excelVersion:c,mainSheet:e.value})})).json()).formula||'=ERROR("No formula returned")',console.log("üß™ Raw backend:",JSON.stringify(x)),n.textContent=x,E("‚úÖ Formula ready","success")}catch(s){console.error("Generation error:",s),n.textContent="‚ùå Error ‚Äî check console",E("‚ö†Ô∏è Formula generation failed","error")}finally{r.disabled=!1}}),o.addEventListener("click",async()=>{if(!x)return E("‚ö†Ô∏è Nothing to insert","warn");let a=ie(x);console.log("üß™ Cleaned before insert:",JSON.stringify(a));try{await Excel.run(async s=>{const c=s.workbook.getSelectedRange();if(c.load("rowCount,columnCount"),await s.sync(),c.rowCount!==1||c.columnCount!==1){const u=new Error("MULTI_CELL");throw u.code="MULTI_CELL",u}c.formulas=[[a]],await s.sync()}),E("‚úÖ Inserted","success")}catch(s){console.error("‚ùå Insert error:",s),E("‚ö†Ô∏è Could not insert formula","error")}})}async function ue(e){try{(await fetch(`${e}/health`)).ok?w("backend:ready"):w("backend:error")}catch{w("backend:error")}}console.log(`üß† ExcelWizPro Taskpane v${H} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});async function de(){const e=await ee();return!await te(e)||!await ne()?!1:(await new Promise(t=>{document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)}),!0)}(async function(){if(console.log("üß† Boot sequence‚Ä¶"),!await de()){console.warn("Office not ready.");return}await oe(),await le();const{showToast:t}=await V(async()=>{const{showToast:n}=await Promise.resolve().then(()=>ce);return{showToast:n}},void 0,import.meta.url);t("‚úÖ ExcelWizPro ready!","success")})();
