(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();const Z=function(e,t,o){let r=Promise.resolve();function n(a){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=a,window.dispatchEvent(c),!c.defaultPrevented)throw a}return r.then(a=>{for(const c of a||[])c.status==="rejected"&&n(c.reason);return e().catch(n)})},ee="13.0.0",te="https://excelwizpro-finalapi.onrender.com",ne=90*1e3,oe=5e4,re=2e4,ae=3;function H(e){return new Promise(t=>setTimeout(t,e))}function E(e){const t=document.getElementById(e);if(!t)throw new Error(`Missing element: #${e}`);return t}function ce(e){let t=e+1,o="";for(;t>0;){const r=(t-1)%26;o=String.fromCharCode(65+r)+o,t=Math.floor((t-1)/26)}return o}function T(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"_")}function ie(){try{return Object.fromEntries(new URLSearchParams(window.location.search))}catch{return{}}}const O=new Map;function M(e,t){return O.has(e)||O.set(e,new Set),O.get(e).add(t),()=>se(e,t)}function se(e,t){const o=O.get(e);o&&o.delete(t)}function b(e,t){const o=O.get(e);if(o)for(const r of o)try{r(t)}catch(n){console.warn(`EventBus handler for '${e}' failed:`,n)}}function le(){var e,t,o,r,n,a,c;try{return{host:((e=Office.context)==null?void 0:e.host)||"unknown",platform:((o=(t=Office.context)==null?void 0:t.diagnostics)==null?void 0:o.platform)||"unknown",version:((n=(r=Office.context)==null?void 0:r.diagnostics)==null?void 0:n.version)||"unknown",build:((c=(a=Office.context)==null?void 0:a.diagnostics)==null?void 0:c.build)||"n/a"}}catch{return{host:"unknown",platform:"unknown",version:"unknown"}}}function ue(){return new Promise(e=>{if(window.Office&&Office.onReady)Office.onReady(e);else{let t=0;const o=setInterval(()=>{t++,window.Office&&Office.onReady&&(clearInterval(o),Office.onReady(e)),t>40&&(clearInterval(o),e({host:"unknown"}))},500)}})}async function de(e){return!e||e.host!==Office.HostType.Excel?(console.warn("‚ö†Ô∏è Not Excel host:",e&&e.host),b("ui:toast",{message:"‚ö†Ô∏è Excel host not detected.",kind:"warn"}),!1):(console.log("üü¢ Excel host OK"),!0)}async function fe(e=20){for(let t=1;t<=e;t++)try{return await Excel.run(async o=>{o.workbook.properties.load("title"),await o.sync()}),!0}catch{await H(350+t*120)}return b("ui:toast",{message:"‚ö†Ô∏è Excel not ready ‚Äî try reopening the add-in.",kind:"warn"}),!1}async function D(e){try{return await Excel.run(e)}catch(t){throw console.warn("Excel.run failed:",t),b("ui:toast",{message:"‚ö†Ô∏è Excel not ready",kind:"error"}),t}}async function me(e){return D(async t=>{const o=t.workbook.worksheets;o.load("items/name"),await t.sync(),e.innerHTML="",o.items.forEach(r=>{const n=document.createElement("option");n.value=r.name,n.textContent=r.name,e.appendChild(n)})})}async function we(){try{await Excel.run(async e=>{const t=e.workbook.worksheets;t.load("items/name"),await e.sync(),t.items.forEach(o=>{try{const r=o.onChanged;r&&r.add&&r.add(async()=>{b("workbook:changed")})}catch(r){console.warn("Sheet change listener unsupported:",r)}})})}catch(e){console.warn("Workbook change listeners failed:",e)}}function pe(){return le().version||"unknown"}function ye(e){if(typeof AbortController>"u")return;const t=new AbortController,o=setTimeout(()=>t.abort(),e);return t.signal.addEventListener("abort",()=>clearTimeout(o)),t.signal}async function ge(e,{timeout:t=re,...o}={}){if(!navigator.onLine){const n=new Error("offline");throw n.code="OFFLINE",n}const r=o.signal||ye(t);return fetch(e,{...o,signal:r})}async function F(e,t={}){let o=null;for(let r=1;r<=ae;r++){try{const n=await ge(e,t);if(!n.ok){o=new Error(`HTTP ${n.status}`),o.status=n.status;continue}return n}catch(n){o=n,n.name==="AbortError"||n.code}await H(300*r)}throw o||new Error("fetchWithRetry failed")}let k=te;function K(){var e;try{const t=ie();if(t.apiBase)return k=t.apiBase,k;if((e=Office==null?void 0:Office.context)!=null&&e.roamingSettings){const o=Office.context.roamingSettings.get("excelwizpro_api_base");if(o)return k=o,k}}catch(t){console.warn("API base resolution error:",t)}return k}async function he(e=5){const t=document.querySelector("main.container"),o=document.createElement("div");Object.assign(o.style,{padding:"6px",marginBottom:"8px",borderRadius:"6px",fontSize:"0.9rem",textAlign:"center"}),t&&t.prepend(o);const r=K();for(let n=1;n<=e;n++){try{if((await F(`${r}/health`,{timeout:4e3})).ok){o.textContent="‚úÖ Backend ready",o.style.background="#e6ffed",o.style.color="#0c7a0c",setTimeout(()=>o.remove(),2e3),b("backend:ready");return}}catch{}o.textContent=`‚è≥ Waking backend‚Ä¶ (${n}/${e})`,o.style.background="#fff4ce",o.style.color="#976f00"}o.textContent="‚ùå Backend unreachable",o.style.background="#fde7e9",o.style.color="#c22",b("backend:error")}async function be(e){const t=K();return(await(await F(`${t}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"})).json()).formula||'=ERROR("No formula returned")'}let C="",P=0,I=!1;async function xe(){return D(async e=>{const t=e.workbook,o=t.worksheets;o.load("items/name,items/visibility"),await e.sync();const r=[],n=Object.create(null);for(const i of o.items){const u=i.visibility,d=u!=="Visible"?` (${u.toLowerCase()})`:"";r.push(`Sheet: ${i.name}${d}`);const f=i.getUsedRangeOrNullObject();if(f.load("rowCount,columnCount,rowIndex,columnIndex,isNullObject"),await e.sync(),f.isNullObject||f.rowCount<2)continue;const v=Math.min(3,f.rowCount),_=i.getRangeByIndexes(f.rowIndex,f.columnIndex,v,f.columnCount);_.load("values");const B=i.tables;B.load("items/name");const j=i.pivotTables;j.load("items/name"),await e.sync();const G=_.values,V=f.rowIndex+v,J=f.rowIndex+f.rowCount-1,S=V+1,Q=S+oe-1,X=J+1,z=Math.min(X,Q);if(z>=S)for(let s=0;s<f.columnCount;s++){const p=[];for(let l=0;l<v;l++){const L=G[l][s];p[l]=L!==null&&L!==""&&L!==void 0?String(L).trim():""}let h="";for(let l=v-1;l>=0;l--)if(p[l]){h=p[l];break}if(!h)continue;let m=h;for(let l=0;l<v-1;l++)if(p[l]&&p[l]!==h){m=`${p[l]} - ${m}`;break}let y=T(m);n[y]?(n[y]+=1,y=`${y}__${n[y]}`):n[y]=1;const A=ce(f.columnIndex+s),Y=i.name.replace(/'/g,"''");r.push(`${y} = '${Y}'!${A}${S}:${A}${z}`)}const q=B.items.map(s=>({table:s,header:s.getHeaderRowRange(),body:s.getDataBodyRange()}));q.forEach(s=>{s.header.load("values"),s.body.load("address,rowCount,columnCount")}),await e.sync();for(const{table:s,header:p}of q)r.push(`Table: ${s.name}`),(p.values&&p.values[0]||[]).forEach(h=>{if(!h)return;let m=T(`${s.name}.${h}`);n[m]?(n[m]+=1,m=`${m}__${n[m]}`):n[m]=1;const y=`${s.name}[${h}]`;r.push(`${m} = ${y}`)});j.items.forEach(s=>r.push(`PivotSource: ${s.name}`))}const a=t.names;a.load("items/name"),await e.sync();const c=[];for(const i of a.items){const u=i.getRange();u.load("address"),c.push({name:i.name,range:u})}return await e.sync(),c.forEach(({name:i,range:u})=>{r.push(`NamedRange: ${i}`);let d=T(i);n[d]?(n[d]+=1,d=`${d}__${n[d]}`):n[d]=1,r.push(`${d} = ${u.address}`)}),r.join(`
`)})}async function R(e=!1){if(!I)try{const t=Date.now();if(!e&&C&&t-P<ne){console.log("üîÑ Using cached Smart Column Map (recent)");return}I=!0,console.log("üîÑ Refreshing Smart Column Map‚Ä¶"),C=await xe(),P=Date.now(),console.log("‚úÖ Updated Smart Column Map"),b("columnMap:updated",{columnMap:C})}catch(t){console.warn("Auto-refresh failed:",t),b("ui:toast",{message:"‚ö†Ô∏è Could not refresh column map",kind:"error"})}finally{I=!1}}function U(){return C}M("workbook:changed",()=>{C="",P=0,console.log("üßπ Column map cache invalidated due to workbook change")});let x=null;function ve(){return x||(x=document.createElement("div"),x.className="exwz-toast-container",Object.assign(x.style,{position:"fixed",bottom:"12px",right:"12px",zIndex:9999,display:"flex",flexDirection:"column",gap:"6px",maxWidth:"260px"}),document.body.appendChild(x),x)}function w(e,t="info"){const o=ve(),r=document.createElement("div");r.className="exwz-toast",r.textContent=e;const n={padding:"8px 10px",borderRadius:"6px",fontSize:"0.85rem",color:"#111",boxShadow:"0 2px 10px rgba(0,0,0,0.15)",background:"#f3f3f3"},a={info:{background:"#e5f1ff",color:"#084f94"},warn:{background:"#fff4ce",color:"#976f00"},error:{background:"#fde7e9",color:"#c22"},success:{background:"#e6ffed",color:"#0c7a0c"}};Object.assign(r.style,n,a[t]||a.info),o.appendChild(r),setTimeout(()=>r.remove(),2600)}const Ee=Object.freeze(Object.defineProperty({__proto__:null,showToast:w},Symbol.toStringTag,{value:"Module"}));let g=null;function ke(){return g||(g=document.createElement("div"),g.className="exwz-error-panel",Object.assign(g.style,{borderRadius:"8px",padding:"8px 10px",marginTop:"8px",background:"#fde7e9",color:"#c22",fontSize:"0.85rem",display:"none"}),(document.querySelector("main.container")||document.body).appendChild(g),g)}function Oe(e,t){const o=ke();if(o.style.display="block",o.innerHTML=`<strong>Error:</strong> ${e}`,t){const r=document.createElement("pre");r.style.marginTop="4px",r.style.whiteSpace="pre-wrap",r.textContent=t,o.appendChild(r)}}function W(){g&&(g.style.display="none",g.innerHTML="")}let $="",N=!1;async function Ce(){const e=E("sheetSelect"),t=E("query"),o=E("output"),r=E("generateBtn"),n=E("clearBtn"),a=document.getElementById("insertBtn");await me(e),await R(!0),he(),M("ui:toast",({message:c,kind:i})=>w(c,i)),M("columnMap:updated",()=>{}),r.addEventListener("click",async()=>{if(N)return;const c=t.value.trim();if(!c)return w("‚ö†Ô∏è Enter a request","warn");if(!navigator.onLine)return w("üì¥ Offline","warn");N=!0,r.disabled=!0,W(),o.textContent="‚è≥ Generating‚Ä¶";try{await R(!1),U()||await R(!0);const i=pe(),u={query:c,columnMap:U(),excelVersion:i,mainSheet:e.value},d=await be(u);$=d,o.textContent=d,w("‚úÖ Formula ready","success")}catch(i){console.error("Generation failed:",i),o.textContent="‚ùå Error ‚Äî see details",Oe("Formula generation failed.",(i==null?void 0:i.message)||String(i))}finally{N=!1,r.disabled=!1}}),n.addEventListener("click",()=>{o.textContent="",t.value="",W()}),a?a.addEventListener("click",async()=>{if(!$)return w("‚ö†Ô∏è No formula to insert","warn");try{await Excel.run(async c=>{const i=c.workbook.getSelectedRange();if(i.load("rowCount,columnCount"),await c.sync(),i.rowCount!==1||i.columnCount!==1){const u=new Error("MULTI_CELL_SELECTION");throw u.code="MULTI_CELL_SELECTION",u}i.formulas=[[$]],await c.sync()}),w("‚úÖ Inserted","success")}catch(c){console.warn("Insert failed:",c),c&&c.code==="MULTI_CELL_SELECTION"?w("‚ö†Ô∏è Select a single cell first","warn"):w("‚ö†Ô∏è Select a cell first","warn")}}):console.warn("No #insertBtn found ‚Äî insert will not be available."),window.addEventListener("online",()=>{$&&w("üåê Back online ‚Äî formula restored","info")}),console.log("üü¢ ExcelWizPro UI ready")}console.log(`üß† ExcelWizPro Taskpane v${ee} starting‚Ä¶`);typeof Office<"u"&&Office&&Office.config&&(Office.config={extendedErrorLogging:!0});(async function(){console.log("üß† Boot sequence‚Ä¶");const e=await ue();if(!await de(e)||!await fe())return;await we(),await Ce();const{showToast:t}=await Z(async()=>{const{showToast:o}=await Promise.resolve().then(()=>Ee);return{showToast:o}});t("‚úÖ ExcelWizPro ready!","success")})();
